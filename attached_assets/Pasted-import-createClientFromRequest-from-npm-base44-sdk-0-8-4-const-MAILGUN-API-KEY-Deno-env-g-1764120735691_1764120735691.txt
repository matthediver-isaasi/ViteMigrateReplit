import { createClientFromRequest } from 'npm:@base44/sdk@0.8.4';

const MAILGUN_API_KEY = Deno.env.get("MAILGUN_API_KEY");
const MAILGUN_DOMAIN = Deno.env.get("MAILGUN_DOMAIN");
const MAILGUN_FROM_EMAIL = Deno.env.get("MAILGUN_FROM_EMAIL");

function generateToken() {
    return Array.from(crypto.getRandomValues(new Uint8Array(32)))
        .map(b => b.toString(16).padStart(2, '0'))
        .join('');
}

async function sendEmailViaMailgun(to, subject, body) {
    const apiBase = 'https://api.eu.mailgun.net/v3';
    
    const formData = new FormData();
    formData.append('from', `AGCAS Events <${MAILGUN_FROM_EMAIL}>`);
    formData.append('to', to);
    formData.append('subject', subject);
    formData.append('text', body);

    const url = `${apiBase}/${MAILGUN_DOMAIN}/messages`;

    const response = await fetch(url, {
        method: 'POST',
        headers: {
            'Authorization': 'Basic ' + btoa(`api:${MAILGUN_API_KEY}`)
        },
        body: formData
    });

    const responseText = await response.text();

    if (!response.ok) {
        throw new Error(`Mailgun API error (${response.status}): ${responseText}`);
    }

    return JSON.parse(responseText);
}

Deno.serve(async (req) => {
    try {
        const base44 = createClientFromRequest(req);
        const { email } = await req.json();
        
        if (!email) {
            return Response.json({ 
                error: 'Email is required' 
            }, { status: 400 });
        }

        console.log('[sendMagicLink] Processing magic link request for:', email);

        // Validate user (checks both TeamMember and Member tables, including login_enabled check)
        const validationResponse = await base44.asServiceRole.functions.invoke('validateUser', { email });
        
        console.log('[sendMagicLink] Validation response:', validationResponse.data);
        
        if (!validationResponse.data.success) {
            return Response.json({ 
                success: false,
                error: validationResponse.data.error || 'Unable to validate user'
            }, { status: 404 });
        }

        console.log('[sendMagicLink] User validated successfully');

        // Generate magic link token
        const token = generateToken();
        const expiresAt = new Date(Date.now() + 30 * 60 * 1000).toISOString();

        // Clean up old/expired magic links for this email
        const existingLinks = await base44.asServiceRole.entities.MagicLink.filter({ email });
        for (const link of existingLinks) {
            await base44.asServiceRole.entities.MagicLink.delete(link.id);
        }

        // Create new magic link
        await base44.asServiceRole.entities.MagicLink.create({
            email,
            token,
            expires_at: expiresAt,
            used: false
        });

        console.log('[sendMagicLink] Magic link created in database');

        // Generate the magic link URL
        const magicLinkUrl = `https://agcas.isaasi.co.uk/VerifyMagicLink?token=${token}`;

        // Send email with magic link via Mailgun
        await sendEmailViaMailgun(
            email,
            'Your AGCAS Events Login Link',
            `
Hello,

Click the link below to access the AGCAS Events portal:

${magicLinkUrl}

This link will expire in 30 minutes.

If you didn't request this login link, please ignore this email.

Best regards,
AGCAS Events Team
            `.trim()
        );

        console.log('[sendMagicLink] Email sent successfully via Mailgun');

        return Response.json({
            success: true,
            message: 'Magic link sent to your email'
        });

    } catch (error) {
        console.error('[sendMagicLink] error:', error);
        return Response.json({ 
            success: false,
            error: 'Failed to send magic link',
            details: error.message 
        }, { status: 500 });
    }
});