import { createClientFromRequest } from 'npm:@base44/sdk@0.7.1';

const XERO_CLIENT_ID = Deno.env.get("XERO_CLIENT_ID");
const XERO_CLIENT_SECRET = Deno.env.get("XERO_CLIENT_SECRET");
const XERO_REDIRECT_URI = Deno.env.get("XERO_REDIRECT_URI");

Deno.serve(async (req) => {
    try {
        const base44 = createClientFromRequest(req);
        const url = new URL(req.url);
        const code = url.searchParams.get('code');
        const error = url.searchParams.get('error');

        if (error) {
            return new Response(`
                <html>
                    <body style="font-family: system-ui; padding: 40px; text-align: center;">
                        <h1 style="color: #dc2626;">Authentication Error</h1>
                        <p>Failed to authenticate with Xero: ${error}</p>
                        <button onclick="window.close()" style="margin-top: 20px; padding: 10px 20px; background: #2563eb; color: white; border: none; border-radius: 6px; cursor: pointer;">
                            Close Window
                        </button>
                    </body>
                </html>
            `, {
                status: 400,
                headers: { 'Content-Type': 'text/html' }
            });
        }

        if (!code) {
            return Response.json({ error: 'No authorization code provided' }, { status: 400 });
        }

        // Exchange code for tokens
        const tokenResponse = await fetch('https://identity.xero.com/connect/token', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'Authorization': 'Basic ' + btoa(`${XERO_CLIENT_ID}:${XERO_CLIENT_SECRET}`)
            },
            body: new URLSearchParams({
                grant_type: 'authorization_code',
                code: code,
                redirect_uri: XERO_REDIRECT_URI,
            }).toString(),
        });

        const tokenData = await tokenResponse.json();

        if (!tokenResponse.ok || tokenData.error) {
            return new Response(`
                <html>
                    <body style="font-family: system-ui; padding: 40px; text-align: center;">
                        <h1 style="color: #dc2626;">Token Exchange Failed</h1>
                        <p>Error: ${JSON.stringify(tokenData)}</p>
                        <button onclick="window.close()" style="margin-top: 20px; padding: 10px 20px; background: #2563eb; color: white; border: none; border-radius: 6px; cursor: pointer;">
                            Close Window
                        </button>
                    </body>
                </html>
            `, {
                status: 400,
                headers: { 'Content-Type': 'text/html' }
            });
        }

        // Get tenant connections
        const connectionsResponse = await fetch('https://api.xero.com/connections', {
            headers: {
                'Authorization': `Bearer ${tokenData.access_token}`,
                'Content-Type': 'application/json'
            }
        });

        const connections = await connectionsResponse.json();
        
        if (!connections || connections.length === 0) {
            return new Response(`
                <html>
                    <body style="font-family: system-ui; padding: 40px; text-align: center;">
                        <h1 style="color: #dc2626;">No Xero Organizations Found</h1>
                        <p>Please ensure your Xero account has at least one organization.</p>
                        <button onclick="window.close()" style="margin-top: 20px; padding: 10px 20px; background: #2563eb; color: white; border: none; border-radius: 6px; cursor: pointer;">
                            Close Window
                        </button>
                    </body>
                </html>
            `, {
                status: 400,
                headers: { 'Content-Type': 'text/html' }
            });
        }

        // Use the first tenant (or you could let admin choose)
        const tenantId = connections[0].tenantId;

        // Calculate expiration
        const expiresAt = new Date(Date.now() + (tokenData.expires_in * 1000)).toISOString();

        // Store tokens using service role
        const existingTokens = await base44.asServiceRole.entities.XeroToken.list();
        
        if (existingTokens.length > 0) {
            await base44.asServiceRole.entities.XeroToken.update(existingTokens[0].id, {
                access_token: tokenData.access_token,
                refresh_token: tokenData.refresh_token,
                expires_at: expiresAt,
                tenant_id: tenantId,
                token_type: tokenData.token_type || 'Bearer',
            });
        } else {
            await base44.asServiceRole.entities.XeroToken.create({
                access_token: tokenData.access_token,
                refresh_token: tokenData.refresh_token,
                expires_at: expiresAt,
                tenant_id: tenantId,
                token_type: tokenData.token_type || 'Bearer',
            });
        }

        return new Response(`
            <html>
                <head>
                    <style>
                        body {
                            font-family: system-ui;
                            padding: 40px;
                            text-align: center;
                            background: linear-gradient(to br, #f8fafc, #eff6ff);
                        }
                        .success { color: #16a34a; margin-bottom: 10px; }
                        button {
                            margin-top: 20px;
                            padding: 12px 24px;
                            background: #2563eb;
                            color: white;
                            border: none;
                            border-radius: 6px;
                            cursor: pointer;
                            font-size: 16px;
                        }
                        button:hover { background: #1d4ed8; }
                    </style>
                </head>
                <body>
                    <h1 class="success">âœ“ Xero Connected Successfully</h1>
                    <p>Your Xero account (${connections[0].tenantName}) has been connected.</p>
                    <p style="font-size: 14px; color: #64748b;">You can now close this window.</p>
                    <button onclick="window.close()">Close Window</button>
                    <script>
                        setTimeout(() => window.close(), 3000);
                    </script>
                </body>
            </html>
        `, {
            headers: { 'Content-Type': 'text/html' },
            status: 200
        });

    } catch (error) {
        return Response.json({ error: error.message }, { status: 500 });
    }
});