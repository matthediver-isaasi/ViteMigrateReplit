import { createClientFromRequest } from 'npm:@base44/sdk@0.8.4';

/**
 * Generates and assigns unique handles to members
 * Can process a single member or all members without handles
 * 
 * Uses custom Member entity authentication (not base44.auth)
 */

function generateSlug(text) {
  return text
    .toLowerCase()
    .trim()
    .replace(/[^a-z0-9]+/g, '-')
    .replace(/^-+|-+$/g, '');
}

function generateUniqueHandle(firstName, lastName, existingHandles) {
  // Start with firstname-lastname
  let baseHandle = `${generateSlug(firstName)}-${generateSlug(lastName)}`;
  
  // If too short, try just firstname
  if (baseHandle.length < 3) {
    baseHandle = generateSlug(firstName);
  }
  
  // If still too short, try just lastname
  if (baseHandle.length < 3) {
    baseHandle = generateSlug(lastName);
  }
  
  // If still too short, default to 'member'
  if (baseHandle.length < 3) {
    baseHandle = 'member';
  }
  
  // Ensure it doesn't exceed 30 chars
  if (baseHandle.length > 30) {
    baseHandle = baseHandle.substring(0, 30);
  }
  
  // Check if handle is unique
  let handle = baseHandle;
  let counter = 1;
  
  while (existingHandles.has(handle)) {
    const suffix = `-${counter}`;
    const maxBaseLength = 30 - suffix.length;
    handle = baseHandle.substring(0, maxBaseLength) + suffix;
    counter++;
  }
  
  return handle;
}

Deno.serve(async (req) => {
  try {
    const base44 = createClientFromRequest(req);
    
    // Parse request body
    const body = await req.json().catch(() => ({}));
    const { member_email, member_id, generate_all = false } = body;
    
    console.log('[generateMemberHandles] Request received:', { member_email, member_id, generate_all });
    
    // Validate that member_email is provided
    if (!member_email) {
      console.log('[generateMemberHandles] No member_email provided');
      return Response.json({ 
        error: 'Unauthorized - member_email required',
        details: 'Please provide your email address in the request'
      }, { status: 401 });
    }
    
    // Check if requesting member is admin using service role
    const members = await base44.asServiceRole.entities.Member.list();
    const currentMember = members.find(m => m.email === member_email);
    
    console.log('[generateMemberHandles] Current member found:', !!currentMember, 'has role_id:', !!currentMember?.role_id);
    
    if (!currentMember) {
      console.log('[generateMemberHandles] Member record not found for email:', member_email);
      return Response.json({ 
        error: 'Forbidden - Member record not found',
        details: 'Your user account is not linked to a member record'
      }, { status: 403 });
    }

    if (!currentMember.role_id) {
      console.log('[generateMemberHandles] Member has no role assigned');
      return Response.json({ 
        error: 'Forbidden - No role assigned',
        details: 'Your account does not have a role assigned'
      }, { status: 403 });
    }
    
    const roles = await base44.asServiceRole.entities.Role.list();
    const currentRole = roles.find(r => r.id === currentMember.role_id);
    
    console.log('[generateMemberHandles] Role found:', !!currentRole, 'is_admin:', currentRole?.is_admin);
    
    if (!currentRole) {
      console.log('[generateMemberHandles] Role not found for role_id:', currentMember.role_id);
      return Response.json({ 
        error: 'Forbidden - Role not found',
        details: 'Your assigned role could not be found'
      }, { status: 403 });
    }

    if (!currentRole.is_admin) {
      console.log('[generateMemberHandles] User is not admin');
      return Response.json({ 
        error: 'Forbidden - Admin access required',
        details: 'This operation requires administrator privileges'
      }, { status: 403 });
    }
    
    console.log('[generateMemberHandles] Admin check passed, proceeding with handle generation');
    
    // Get all members
    const allMembers = await base44.asServiceRole.entities.Member.list();
    console.log('[generateMemberHandles] Total members:', allMembers.length);
    
    // Get existing handles
    const existingHandles = new Set(
      allMembers
        .filter(m => m.handle)
        .map(m => m.handle)
    );
    
    console.log('[generateMemberHandles] Existing handles:', existingHandles.size);
    
    const results = {
      success: [],
      failed: [],
      skipped: []
    };
    
    // Determine which members to process
    let membersToProcess = [];
    
    if (member_id) {
      // Process single member
      const member = allMembers.find(m => m.id === member_id);
      if (!member) {
        return Response.json({ error: 'Member not found' }, { status: 404 });
      }
      membersToProcess = [member];
    } else if (generate_all) {
      // Process all members without handles
      membersToProcess = allMembers.filter(m => !m.handle);
      console.log('[generateMemberHandles] Members to process:', membersToProcess.length);
    } else {
      return Response.json({ 
        error: 'Please specify either member_id or set generate_all to true' 
      }, { status: 400 });
    }
    
    // Process each member
    for (const member of membersToProcess) {
      try {
        // Skip if member already has a handle
        if (member.handle) {
          results.skipped.push({
            member_id: member.id,
            email: member.email,
            existing_handle: member.handle,
            reason: 'Already has handle'
          });
          continue;
        }
        
        // Skip if member doesn't have first and last name
        if (!member.first_name || !member.last_name) {
          results.failed.push({
            member_id: member.id,
            email: member.email,
            error: 'Missing first_name or last_name'
          });
          continue;
        }
        
        // Generate unique handle
        const handle = generateUniqueHandle(
          member.first_name,
          member.last_name,
          existingHandles
        );
        
        console.log('[generateMemberHandles] Generated handle for', member.email, ':', handle);
        
        // Update member with handle
        await base44.asServiceRole.entities.Member.update(member.id, { handle });
        
        // Add to existing handles set for subsequent iterations
        existingHandles.add(handle);
        
        results.success.push({
          member_id: member.id,
          email: member.email,
          name: `${member.first_name} ${member.last_name}`,
          handle: handle
        });
        
      } catch (error) {
        console.error('[generateMemberHandles] Error processing member:', member.email, error);
        results.failed.push({
          member_id: member.id,
          email: member.email,
          error: error.message
        });
      }
    }
    
    console.log('[generateMemberHandles] Results:', results.success.length, 'success,', results.failed.length, 'failed,', results.skipped.length, 'skipped');
    
    return Response.json({
      message: 'Handle generation completed',
      summary: {
        total_processed: membersToProcess.length,
        successful: results.success.length,
        failed: results.failed.length,
        skipped: results.skipped.length
      },
      results
    });
    
  } catch (error) {
    console.error('[generateMemberHandles] Fatal error:', error);
    return Response.json({ 
      error: 'Failed to generate handles',
      details: error.message,
      stack: error.stack
    }, { status: 500 });
  }
});