import { createClientFromRequest } from 'npm:@base44/sdk@0.7.1';

Deno.serve(async (req) => {
    try {
        const base44 = createClientFromRequest(req);
        
        console.log('[clearProgramTicketTransactions] ========================================');
        console.log('[clearProgramTicketTransactions] CLEAR PROGRAM TICKET TRANSACTIONS FUNCTION CALLED');
        console.log('[clearProgramTicketTransactions] ========================================');
        console.log('[clearProgramTicketTransactions] WARNING: This will delete ALL program ticket transaction records');
        
        // Fetch all transactions using service role
        console.log('[clearProgramTicketTransactions] Fetching all transactions...');
        const allTransactions = await base44.asServiceRole.entities.ProgramTicketTransaction.list();
        
        console.log(`[clearProgramTicketTransactions] Found ${allTransactions.length} transaction(s) to delete`);
        
        if (allTransactions.length === 0) {
            console.log('[clearProgramTicketTransactions] No transactions to delete');
            return Response.json({
                success: true,
                deleted_count: 0,
                message: 'No program ticket transactions found to delete'
            });
        }
        
        // Delete each transaction
        let deletedCount = 0;
        let errorCount = 0;
        const errors = [];
        
        for (const transaction of allTransactions) {
            try {
                await base44.asServiceRole.entities.ProgramTicketTransaction.delete(transaction.id);
                deletedCount++;
                console.log(`[clearProgramTicketTransactions] ✓ Deleted transaction ${transaction.id} (${transaction.transaction_type} - ${transaction.program_name})`);
                
                // Add a small delay to avoid rate limiting
                await new Promise(resolve => setTimeout(resolve, 50));
            } catch (error) {
                errorCount++;
                console.error(`[clearProgramTicketTransactions] ✗ Failed to delete transaction ${transaction.id}:`, error.message);
                errors.push({
                    transaction_id: transaction.id,
                    program_name: transaction.program_name,
                    transaction_type: transaction.transaction_type,
                    error: error.message
                });
            }
        }
        
        console.log('[clearProgramTicketTransactions] ========================================');
        console.log(`[clearProgramTicketTransactions] DELETION COMPLETE`);
        console.log(`[clearProgramTicketTransactions] Successfully deleted: ${deletedCount}`);
        console.log(`[clearProgramTicketTransactions] Failed: ${errorCount}`);
        console.log('[clearProgramTicketTransactions] ========================================');
        
        return Response.json({
            success: true,
            deleted_count: deletedCount,
            error_count: errorCount,
            total_processed: allTransactions.length,
            errors: errors.length > 0 ? errors : undefined,
            message: `Successfully deleted ${deletedCount} transaction(s)${errorCount > 0 ? `. ${errorCount} deletion(s) failed.` : ''}`
        });

    } catch (error) {
        console.error('[clearProgramTicketTransactions] Fatal error:', error);
        return Response.json({ 
            success: false,
            error: 'Failed to clear program ticket transactions',
            details: error.message 
        }, { status: 500 });
    }
});