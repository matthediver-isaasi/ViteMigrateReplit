import { createClientFromRequest } from 'npm:@base44/sdk@0.7.1';

Deno.serve(async (req) => {
    try {
        const base44 = createClientFromRequest(req);
        
        const { transactionId, adminEmail } = await req.json();
        
        console.log('[reinstateProgramTicketTransaction] ========================================');
        console.log('[reinstateProgramTicketTransaction] Reinstatement request received');
        console.log('[reinstateProgramTicketTransaction] Transaction ID:', transactionId);
        console.log('[reinstateProgramTicketTransaction] Admin Email:', adminEmail);
        
        // Validate inputs
        if (!transactionId || !adminEmail) {
            return Response.json({
                success: false,
                error: 'Missing required parameters',
                required: ['transactionId', 'adminEmail']
            }, { status: 400 });
        }

        // Verify admin privileges
        const allMembers = await base44.asServiceRole.entities.Member.list();
        const adminMember = allMembers.find(m => m.email === adminEmail);
        
        if (!adminMember || !adminMember.role_id) {
            return Response.json({
                success: false,
                error: 'Admin user not found or has no role assigned'
            }, { status: 403 });
        }

        const allRoles = await base44.asServiceRole.entities.Role.list();
        const adminRole = allRoles.find(r => r.id === adminMember.role_id);
        
        if (!adminRole || !adminRole.is_admin) {
            return Response.json({
                success: false,
                error: 'User does not have administrator privileges'
            }, { status: 403 });
        }

        console.log('[reinstateProgramTicketTransaction] Admin authorization verified');

        // Fetch the transaction
        const allTransactions = await base44.asServiceRole.entities.ProgramTicketTransaction.list();
        const transaction = allTransactions.find(t => t.id === transactionId);

        if (!transaction) {
            return Response.json({
                success: false,
                error: 'Transaction not found'
            }, { status: 404 });
        }

        console.log('[reinstateProgramTicketTransaction] Transaction found:', {
            type: transaction.transaction_type,
            program: transaction.program_name,
            original_quantity: transaction.original_quantity || transaction.quantity,
            cancelled_quantity: transaction.cancelled_quantity || 0,
            status: transaction.status
        });

        // Validate transaction type
        if (transaction.transaction_type !== 'purchase') {
            return Response.json({
                success: false,
                error: 'Only purchase transactions can be reinstated',
                transaction_type: transaction.transaction_type
            }, { status: 400 });
        }

        // Get the quantity to reinstate
        const quantityToReinstate = transaction.cancelled_quantity || 0;

        if (quantityToReinstate <= 0) {
            return Response.json({
                success: false,
                error: 'No cancelled tickets to reinstate',
                cancelled_quantity: quantityToReinstate
            }, { status: 400 });
        }

        console.log('[reinstateProgramTicketTransaction] Quantity to reinstate:', quantityToReinstate);

        // Fetch the organization
        const allOrganizations = await base44.asServiceRole.entities.Organization.list();
        const organization = allOrganizations.find(o => o.id === transaction.organization_id);

        if (!organization) {
            return Response.json({
                success: false,
                error: 'Organization not found'
            }, { status: 404 });
        }

        // All validations passed - proceed with reinstatement
        console.log('[reinstateProgramTicketTransaction] ✓ All validations passed. Proceeding with reinstatement...');

        // Update the transaction record back to active
        const transactionUpdates = {
            cancelled_quantity: 0,
            status: 'active',
            cancelled_by_member_email: null,
            cancelled_at: null
        };

        await base44.asServiceRole.entities.ProgramTicketTransaction.update(transactionId, transactionUpdates);
        console.log('[reinstateProgramTicketTransaction] ✓ Transaction record updated back to active');

        // Update organization's balance - add the tickets back
        const currentOrgBalance = (organization.program_ticket_balances || {})[transaction.program_name] || 0;
        const updatedProgramBalances = {
            ...organization.program_ticket_balances,
            [transaction.program_name]: currentOrgBalance + quantityToReinstate
        };

        await base44.asServiceRole.entities.Organization.update(organization.id, {
            program_ticket_balances: updatedProgramBalances,
            last_synced: new Date().toISOString()
        });
        console.log('[reinstateProgramTicketTransaction] ✓ Organization balance updated - tickets reinstated');

        // Create audit trail transaction with type 'reinstatement'
        await base44.asServiceRole.entities.ProgramTicketTransaction.create({
            organization_id: transaction.organization_id,
            program_name: transaction.program_name,
            transaction_type: 'reinstatement',
            quantity: quantityToReinstate,
            member_email: adminEmail,
            original_transaction_id: transactionId,
            notes: `Admin reinstatement: ${quantityToReinstate} ticket(s) reinstated after cancellation reversal. Original PO: ${transaction.purchase_order_number || 'N/A'}. Reinstated by: ${adminEmail}.`
        });
        console.log('[reinstateProgramTicketTransaction] ✓ Audit trail created with type "reinstatement"');

        console.log('[reinstateProgramTicketTransaction] ========================================');
        console.log('[reinstateProgramTicketTransaction] REINSTATEMENT SUCCESSFUL');
        console.log('[reinstateProgramTicketTransaction] ========================================');

        return Response.json({
            success: true,
            message: `Successfully reinstated ${quantityToReinstate} ticket(s)`,
            transaction_id: transactionId,
            quantity_reinstated: quantityToReinstate,
            new_organization_balance: updatedProgramBalances[transaction.program_name]
        });

    } catch (error) {
        console.error('[reinstateProgramTicketTransaction] Fatal error:', error);
        return Response.json({
            success: false,
            error: 'Failed to reinstate transaction',
            details: error.message
        }, { status: 500 });
    }
});