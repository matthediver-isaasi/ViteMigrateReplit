import { createClientFromRequest } from 'npm:@base44/sdk@0.7.1';

Deno.serve(async (req) => {
    try {
        const base44 = createClientFromRequest(req);
        
        const { code, totalCost, programTag, memberEmail } = await req.json();

        console.log('[applyDiscountCode] Request received:', { code, totalCost, programTag, memberEmail });

        if (!code || !totalCost || typeof totalCost !== 'number' || totalCost < 0) {
            console.error('[applyDiscountCode] Invalid input validation failed');
            return Response.json({ 
                success: false, 
                error: 'Invalid input: code and a valid totalCost are required.' 
            }, { status: 200 });
        }

        if (!memberEmail) {
            console.error('[applyDiscountCode] Member email missing');
            return Response.json({ 
                success: false, 
                error: 'Member email is required.' 
            }, { status: 200 });
        }

        // Get member's organization
        const allMembers = await base44.asServiceRole.entities.Member.list();
        const member = allMembers.find(m => m.email === memberEmail);

        if (!member || !member.organization_id) {
            console.error('[applyDiscountCode] Member or organization not found');
            return Response.json({ 
                success: false, 
                error: 'Member organization not found.' 
            }, { status: 200 });
        }

        const memberOrgId = member.organization_id;

        // Find discount codes that match the code AND are either:
        // 1. Global (no organization_id)
        // 2. Specific to this member's organization
        const allDiscountCodes = await base44.asServiceRole.entities.DiscountCode.list();
        const matchingCodes = allDiscountCodes.filter(dc => 
            dc.code.toUpperCase() === code.toUpperCase() &&
            (!dc.organization_id || dc.organization_id === memberOrgId)
        );

        if (matchingCodes.length === 0) {
            console.error('[applyDiscountCode] Discount code not found or not available to this organization:', code);
            return Response.json({ success: false, error: 'Invalid discount code.' }, { status: 200 });
        }

        const discountCode = matchingCodes[0];
        console.log('[applyDiscountCode] Found discount code:', { 
            id: discountCode.id, 
            code: discountCode.code, 
            type: discountCode.type, 
            value: discountCode.value,
            is_active: discountCode.is_active,
            expires_at: discountCode.expires_at,
            min_purchase_amount: discountCode.min_purchase_amount,
            max_usage_count: discountCode.max_usage_count,
            current_usage_count: discountCode.current_usage_count,
            program_tag: discountCode.program_tag,
            organization_id: discountCode.organization_id,
            is_organization_specific: !!discountCode.organization_id
        });

        // Validate discount code status and expiry
        if (!discountCode.is_active) {
            console.error('[applyDiscountCode] Discount code is inactive');
            return Response.json({ success: false, error: 'Invalid discount code.' }, { status: 200 });
        }

        if (discountCode.expires_at && new Date(discountCode.expires_at) < new Date()) {
            console.error('[applyDiscountCode] Discount code has expired');
            return Response.json({ success: false, error: 'Invalid discount code.' }, { status: 200 });
        }

        // Validate minimum purchase amount
        if (discountCode.min_purchase_amount > 0 && totalCost < discountCode.min_purchase_amount) {
            console.error('[applyDiscountCode] Minimum purchase amount not met:', { 
                required: discountCode.min_purchase_amount, 
                actual: totalCost 
            });
            return Response.json({ 
                success: false, 
                error: 'Invalid discount code.' 
            }, { status: 200 });
        }

        // Validate usage count based on whether code is organization-specific
        if (discountCode.max_usage_count) {
            let currentUsage = 0;

            if (discountCode.organization_id) {
                // Organization-specific code: check DiscountCodeUsage
                const usageRecords = await base44.asServiceRole.entities.DiscountCodeUsage.filter({
                    discount_code_id: discountCode.id,
                    organization_id: memberOrgId
                });
                
                if (usageRecords.length > 0) {
                    currentUsage = usageRecords[0].usage_count || 0;
                }

                console.log('[applyDiscountCode] Organization-specific code usage:', {
                    organization_id: memberOrgId,
                    current_usage: currentUsage,
                    max_usage: discountCode.max_usage_count
                });
            } else {
                // Global code: check current_usage_count on DiscountCode
                currentUsage = discountCode.current_usage_count || 0;
                console.log('[applyDiscountCode] Global code usage:', {
                    current_usage: currentUsage,
                    max_usage: discountCode.max_usage_count
                });
            }

            if (currentUsage >= discountCode.max_usage_count) {
                console.error('[applyDiscountCode] Max usage count reached');
                return Response.json({ success: false, error: 'Invalid discount code.' }, { status: 200 });
            }
        }

        // Validate program tag if specified
        if (discountCode.program_tag && discountCode.program_tag !== programTag) {
            console.error('[applyDiscountCode] Program tag mismatch:', { 
                required: discountCode.program_tag, 
                provided: programTag 
            });
            return Response.json({ 
                success: false, 
                error: 'Invalid discount code.' 
            }, { status: 200 });
        }

        // Calculate discount amount
        let discountAmount = 0;
        if (discountCode.type === 'percentage') {
            discountAmount = totalCost * (discountCode.value / 100);
        } else if (discountCode.type === 'fixed') {
            discountAmount = discountCode.value;
        }

        // Ensure discount doesn't make total cost negative
        discountAmount = Math.min(discountAmount, totalCost);
        const totalCostAfterDiscount = Math.max(0, totalCost - discountAmount);

        console.log('[applyDiscountCode] Discount calculated successfully:', { 
            discountAmount, 
            totalCostAfterDiscount 
        });

        return Response.json({
            success: true,
            discountId: discountCode.id,
            code: discountCode.code,
            type: discountCode.type,
            value: discountCode.value,
            discountAmount: parseFloat(discountAmount.toFixed(2)),
            totalCostAfterDiscount: parseFloat(totalCostAfterDiscount.toFixed(2)),
            isOrganizationSpecific: !!discountCode.organization_id,
            message: 'Discount applied successfully!'
        });

    } catch (error) {
        console.error('[applyDiscountCode] Unexpected error:', error);
        return Response.json({ 
            success: false, 
            error: 'Failed to apply discount code.' 
        }, { status: 500 });
    }
});