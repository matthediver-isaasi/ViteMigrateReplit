import { createClientFromRequest } from 'npm:@base44/sdk@0.7.1';

const XERO_CLIENT_ID = Deno.env.get("XERO_CLIENT_ID");
const XERO_CLIENT_SECRET = Deno.env.get("XERO_CLIENT_SECRET");

Deno.serve(async (req) => {
    try {
        const base44 = createClientFromRequest(req);
        
        // Get current token
        const tokens = await base44.asServiceRole.entities.XeroToken.list();
        
        if (tokens.length === 0) {
            return Response.json({ 
                error: 'No Xero token found. Please authenticate first.' 
            }, { status: 404 });
        }

        const currentToken = tokens[0];
        
        // Check if token needs refresh (refresh if expires in next 5 minutes)
        const expiresAt = new Date(currentToken.expires_at);
        const now = new Date();
        const fiveMinutesFromNow = new Date(now.getTime() + 5 * 60 * 1000);
        
        if (expiresAt > fiveMinutesFromNow) {
            return Response.json({ 
                message: 'Token is still valid',
                expires_at: currentToken.expires_at 
            });
        }

        // Refresh the token
        const tokenResponse = await fetch('https://identity.xero.com/connect/token', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'Authorization': 'Basic ' + btoa(`${XERO_CLIENT_ID}:${XERO_CLIENT_SECRET}`)
            },
            body: new URLSearchParams({
                grant_type: 'refresh_token',
                refresh_token: currentToken.refresh_token,
            }).toString(),
        });

        const tokenData = await tokenResponse.json();

        if (!tokenResponse.ok || tokenData.error) {
            return Response.json({ 
                error: 'Failed to refresh token',
                details: tokenData 
            }, { status: 400 });
        }

        // Calculate new expiry
        const newExpiresAt = new Date(Date.now() + (tokenData.expires_in * 1000)).toISOString();

        // Update stored token
        await base44.asServiceRole.entities.XeroToken.update(currentToken.id, {
            access_token: tokenData.access_token,
            refresh_token: tokenData.refresh_token,
            expires_at: newExpiresAt,
        });

        return Response.json({
            success: true,
            message: 'Token refreshed successfully',
            expires_at: newExpiresAt
        });

    } catch (error) {
        return Response.json({ 
            error: 'Failed to refresh Xero token',
            message: error.message 
        }, { status: 500 });
    }
});