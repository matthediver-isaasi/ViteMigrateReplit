import { createClientFromRequest } from 'npm:@base44/sdk@0.8.4';

const ZOHO_CRM_API_DOMAIN = Deno.env.get("ZOHO_CRM_API_DOMAIN");
const ZOHO_CLIENT_ID = Deno.env.get("ZOHO_CLIENT_ID");
const ZOHO_CLIENT_SECRET = Deno.env.get("ZOHO_CLIENT_SECRET");

async function getValidAccessToken(base44) {
    console.log('[getValidAccessToken] ===== START TOKEN RETRIEVAL =====');
    console.log('[getValidAccessToken] Fetching ZohoToken from database...');
    
    const tokens = await base44.asServiceRole.entities.ZohoToken.list();
    console.log('[getValidAccessToken] Found', tokens.length, 'token(s) in database');
    
    if (tokens.length === 0) {
        console.error('[getValidAccessToken] ‚ùå CRITICAL: No Zoho tokens found in database');
        console.error('[getValidAccessToken] Admin must complete OAuth setup via AdminSetup page');
        throw new Error('No Zoho tokens found. Admin needs to authenticate first.');
    }
    
    const token = tokens[0];
    const now = new Date();
    const expiresAt = new Date(token.expires_at);
    
    console.log('[getValidAccessToken] Token status:');
    console.log('[getValidAccessToken]   - Token ID:', token.id);
    console.log('[getValidAccessToken]   - Expires at:', token.expires_at);
    console.log('[getValidAccessToken]   - Current time:', now.toISOString());
    console.log('[getValidAccessToken]   - Is valid:', expiresAt > now);
    
    if (expiresAt > now) {
        console.log('[getValidAccessToken] ‚úÖ Token is still valid, using existing access token');
        console.log('[getValidAccessToken] ===== END TOKEN RETRIEVAL =====');
        return token.access_token;
    }
    
    console.log('[getValidAccessToken] ‚ö†Ô∏è Token expired, attempting refresh...');
    
    function getAccountsDomain(apiDomain) {
        if (apiDomain.includes('.zohoapis.eu')) {
            return 'https://accounts.zoho.eu';
        } else if (apiDomain.includes('.zohoapis.com.au')) {
            return 'https://accounts.zoho.com.au';
        } else {
            return 'https://accounts.zoho.com';
        }
    }
    
    const accountsDomain = getAccountsDomain(ZOHO_CRM_API_DOMAIN);
    console.log('[getValidAccessToken] Using accounts domain:', accountsDomain);
    console.log('[getValidAccessToken] Making refresh token request...');
    
    const refreshResponse = await fetch(`${accountsDomain}/oauth/v2/token`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: new URLSearchParams({
            grant_type: 'refresh_token',
            client_id: ZOHO_CLIENT_ID,
            client_secret: ZOHO_CLIENT_SECRET,
            refresh_token: token.refresh_token,
        }),
    });
    
    console.log('[getValidAccessToken] Refresh response status:', refreshResponse.status);
    
    const refreshData = await refreshResponse.json();
    console.log('[getValidAccessToken] Refresh response data:', JSON.stringify(refreshData, null, 2));
    
    if (refreshData.error) {
        console.error('[getValidAccessToken] ‚ùå Token refresh failed:', refreshData.error);
        throw new Error(`Failed to refresh token: ${refreshData.error}`);
    }
    
    const newExpiresAt = new Date(Date.now() + (refreshData.expires_in * 1000)).toISOString();
    console.log('[getValidAccessToken] Updating token in database with new expiry:', newExpiresAt);
    
    await base44.asServiceRole.entities.ZohoToken.update(token.id, {
        access_token: refreshData.access_token,
        expires_at: newExpiresAt,
    });
    
    console.log('[getValidAccessToken] ‚úÖ Token refreshed successfully');
    console.log('[getValidAccessToken] ===== END TOKEN RETRIEVAL =====');
    return refreshData.access_token;
}

Deno.serve(async (req) => {
    console.log('\n\n========================================');
    console.log('validateUser FUNCTION CALLED');
    console.log('========================================\n');
    
    try {
        const base44 = createClientFromRequest(req);
        const requestBody = await req.json();
        const { email } = requestBody;
        
        console.log('[validateUser] üìß Email to validate:', email);
        console.log('[validateUser] üîß Environment check:');
        console.log('[validateUser]   - ZOHO_CRM_API_DOMAIN:', ZOHO_CRM_API_DOMAIN ? '‚úÖ Set' : '‚ùå NOT SET');
        console.log('[validateUser]   - ZOHO_CLIENT_ID:', ZOHO_CLIENT_ID ? '‚úÖ Set' : '‚ùå NOT SET');
        console.log('[validateUser]   - ZOHO_CLIENT_SECRET:', ZOHO_CLIENT_SECRET ? '‚úÖ Set' : '‚ùå NOT SET');
        
        if (!email) {
            console.warn('[validateUser] ‚ùå No email provided in request');
            return Response.json({ 
                error: 'Email is required' 
            }, { status: 400 });
        }
        
        // Step 1: Check if this is a TeamMember first
        console.log('\n[validateUser] üë• STEP 1: Checking TeamMember table...');
        const allTeamMembers = await base44.asServiceRole.entities.TeamMember.list();
        console.log('[validateUser] Found', allTeamMembers.length, 'total team members in database');
        
        const teamMember = allTeamMembers.find(tm => tm.email === email && tm.is_active === true);
        
        if (teamMember) {
            console.log('[validateUser] ‚úÖ MATCH FOUND: Active TeamMember with email:', teamMember.email);
            console.log('[validateUser] TeamMember details:', JSON.stringify(teamMember, null, 2));
            console.log('[validateUser] Returning TeamMember user data');
            console.log('========================================\n\n');
            
            return Response.json({
                success: true,
                user: {
                    email: teamMember.email,
                    first_name: teamMember.first_name,
                    last_name: teamMember.last_name,
                    role_id: teamMember.role_id,
                    is_team_member: true,
                    member_excluded_features: [],
                    has_seen_onboarding_tour: teamMember.has_seen_onboarding_tour || false
                }
            });
        }
        
        console.log('[validateUser] ‚ùå No matching TeamMember found');
        
        // Step 2: Check Zoho CRM for regular Member
        console.log('\n[validateUser] üîç STEP 2: Checking Zoho CRM...');
        console.log('[validateUser] Getting Zoho access token...');
        
        let accessToken;
        try {
            accessToken = await getValidAccessToken(base44);
            console.log('[validateUser] ‚úÖ Successfully obtained access token');
            console.log('[validateUser] Token length:', accessToken?.length || 0);
        } catch (authError) {
            console.error('[validateUser] ‚ùå FATAL: Failed to get Zoho Access Token');
            console.error('[validateUser] Error:', authError.message);
            console.error('[validateUser] Stack:', authError.stack);
            console.log('========================================\n\n');
            
            return Response.json({
                success: false,
                error: 'Zoho integration error. Please contact support.',
                details: authError.message
            }, { status: 500 });
        }

        console.log('\n[validateUser] üåê Preparing Zoho CRM API call...');
        const criteria = `(Email:equals:${email})`;
        const searchUrl = `${ZOHO_CRM_API_DOMAIN}/crm/v3/Contacts/search?criteria=${encodeURIComponent(criteria)}`;
        
        console.log('[validateUser] Search criteria:', criteria);
        console.log('[validateUser] Full search URL:', searchUrl);
        console.log('[validateUser] Making API request to Zoho CRM...');
        
        const searchResponse = await fetch(searchUrl, {
            headers: {
                'Authorization': `Zoho-oauthtoken ${accessToken}`,
            },
        });
        
        console.log('[validateUser] üì° Zoho CRM Response:');
        console.log('[validateUser]   - Status code:', searchResponse.status);
        console.log('[validateUser]   - Status text:', searchResponse.statusText);
        console.log('[validateUser]   - Headers:', JSON.stringify(Object.fromEntries(searchResponse.headers.entries()), null, 2));
        
        let searchData;
        try {
            searchData = await searchResponse.json();
            console.log('[validateUser] üì¶ Response body (full):', JSON.stringify(searchData, null, 2));
        } catch (parseError) {
            console.error('[validateUser] ‚ùå Failed to parse response as JSON');
            console.error('[validateUser] Parse error:', parseError.message);
            const responseText = await searchResponse.text();
            console.error('[validateUser] Raw response text:', responseText);
            console.log('========================================\n\n');
            
            return Response.json({ 
                success: false,
                error: 'Invalid response from CRM',
                details: 'Could not parse CRM response'
            }, { status: 500 });
        }

        if (!searchResponse.ok) {
            console.error('[validateUser] ‚ùå CRM search failed with status:', searchResponse.status);
            console.error('[validateUser] Error details:', JSON.stringify(searchData, null, 2));
            console.log('========================================\n\n');
            
            return Response.json({ 
                success: false,
                error: 'Error searching CRM. Please try again.',
                details: searchData
            }, { status: searchResponse.status });
        }
        
        console.log('[validateUser] Analyzing search results...');
        console.log('[validateUser]   - Has data property:', !!searchData.data);
        console.log('[validateUser]   - Data is array:', Array.isArray(searchData.data));
        console.log('[validateUser]   - Number of results:', searchData.data?.length || 0);
        
        if (!searchData.data || searchData.data.length === 0) {
            console.warn('[validateUser] ‚ùå NO MATCH: Email not found in Zoho CRM:', email);
            console.warn('[validateUser] This could mean:');
            console.warn('[validateUser]   1. Email does not exist in CRM Contacts');
            console.warn('[validateUser]   2. Email field spelling is different');
            console.warn("[validateUser]   3. Contact exists but email doesn't match exactly");
            console.log('========================================\n\n');
            
            return Response.json({ 
                success: false,
                error: 'Email not found. Please check your email address or contact support.'
            }, { status: 404 });
        }
        
        const contact = searchData.data[0];
        console.log('[validateUser] ‚úÖ CONTACT FOUND in Zoho CRM!');
        console.log('[validateUser] Contact details:');
        console.log('[validateUser]   - ID:', contact.id);
        console.log('[validateUser]   - Email:', contact.Email);
        console.log('[validateUser]   - First Name:', contact.First_Name);
        console.log('[validateUser]   - Last Name:', contact.Last_Name);
        console.log('[validateUser]   - Has Account:', !!contact.Account_Name?.id);
        if (contact.Account_Name?.id) {
            console.log('[validateUser]   - Account ID:', contact.Account_Name.id);
            console.log('[validateUser]   - Account Name:', contact.Account_Name.name);
        }
        
        let organizationId = null;
        let organizationName = null;
        let trainingFundBalance = 0;
        let purchaseOrderEnabled = false;
        let programTicketBalances = {};
        
        if (contact.Account_Name?.id) {
            console.log('\n[validateUser] üè¢ STEP 3: Fetching Account (Organization) details...');
            const accountUrl = `${ZOHO_CRM_API_DOMAIN}/crm/v3/Accounts/${contact.Account_Name.id}`;
            console.log('[validateUser] Account API URL:', accountUrl);
            
            const accountResponse = await fetch(accountUrl, {
                headers: {
                    'Authorization': `Zoho-oauthtoken ${accessToken}`,
                },
            });
            
            console.log('[validateUser] Account response status:', accountResponse.status);
            
            if (accountResponse.ok) {
                const accountData = await accountResponse.json();
                const account = accountData.data[0];
                
                console.log('[validateUser] ‚úÖ Account details retrieved:');
                console.log('[validateUser]   - Account ID:', account.id);
                console.log('[validateUser]   - Account Name:', account.Account_Name);
                console.log('[validateUser]   - Training Fund Balance:', account.Training_Fund_Balance);
                console.log('[validateUser]   - Purchase Order Enabled:', account.Purchase_Order_Enabled);
                
                organizationName = account.Account_Name;
                organizationId = account.id;
                trainingFundBalance = account.Training_Fund_Balance || 0;
                purchaseOrderEnabled = account.Purchase_Order_Enabled || false;
                
                console.log('\n[validateUser] üíæ Syncing Organization to Base44...');
                const existingOrgs = await base44.asServiceRole.entities.Organization.filter({
                    zoho_account_id: organizationId
                });
                
                console.log('[validateUser] Existing organizations found:', existingOrgs.length);
                
                if (existingOrgs.length > 0) {
                    console.log('[validateUser] Updating existing Organization:', existingOrgs[0].id);
                    await base44.asServiceRole.entities.Organization.update(existingOrgs[0].id, {
                        name: organizationName,
                        training_fund_balance: trainingFundBalance,
                        purchase_order_enabled: purchaseOrderEnabled,
                        last_synced: new Date().toISOString()
                    });
                    programTicketBalances = existingOrgs[0].program_ticket_balances || {};
                    console.log('[validateUser] ‚úÖ Organization updated');
                } else {
                    console.log('[validateUser] Creating new Organization record');
                    const newOrg = await base44.asServiceRole.entities.Organization.create({
                        name: organizationName,
                        zoho_account_id: organizationId,
                        training_fund_balance: trainingFundBalance,
                        purchase_order_enabled: purchaseOrderEnabled,
                        last_synced: new Date().toISOString()
                    });
                    programTicketBalances = newOrg.program_ticket_balances || {};
                    console.log('[validateUser] ‚úÖ Organization created with ID:', newOrg.id);
                }
            } else {
                console.warn('[validateUser] ‚ö†Ô∏è Failed to fetch Account details, status:', accountResponse.status);
                const errorText = await accountResponse.text();
                console.warn('[validateUser] Account error response:', errorText);
            }
        } else {
            console.log('[validateUser] ‚ÑπÔ∏è Contact has no associated Account in CRM');
        }
        
        console.log('\n[validateUser] üë§ STEP 4: Syncing Member to Base44...');
        const allMembers = await base44.asServiceRole.entities.Member.list();
        console.log('[validateUser] Total members in Base44:', allMembers.length);
        
        const existingMember = allMembers.find(m => m.email === email);
        console.log('[validateUser] Existing member found:', !!existingMember);
        
        // Check login_enabled status for existing members
        if (existingMember && existingMember.login_enabled === false) {
            console.warn('[validateUser] ‚ùå Login disabled for member:', email);
            console.log('========================================\n\n');
            return Response.json({
                success: false,
                error: 'Your account access has been disabled. Please contact your organization administrator.'
            }, { status: 403 });
        }
        
        // Prepare Zoho-sourced fields
        const zohoMemberData = {
            email: email,
            first_name: contact.First_Name,
            last_name: contact.Last_Name,
            zoho_contact_id: contact.id,
            organization_id: organizationId,
            last_synced: new Date().toISOString()
        };
        
        console.log('[validateUser] Zoho member data:', JSON.stringify(zohoMemberData, null, 2));
        
        let member;
        if (existingMember) {
            console.log('[validateUser] Updating existing Member:', existingMember.id);
            console.log('[validateUser] PRESERVING existing app-specific fields:');
            console.log('[validateUser]   - page_tours_seen:', JSON.stringify(existingMember.page_tours_seen || {}));
            console.log('[validateUser]   - role_id:', existingMember.role_id || 'null');
            console.log('[validateUser]   - member_excluded_features:', JSON.stringify(existingMember.member_excluded_features || []));
            console.log('[validateUser]   - has_seen_onboarding_tour:', existingMember.has_seen_onboarding_tour || false);
            console.log('[validateUser]   - login_enabled:', existingMember.login_enabled ?? true);
            
            // Update only Zoho fields, preserve app-specific fields
            await base44.asServiceRole.entities.Member.update(existingMember.id, zohoMemberData);
            
            // Construct the complete member object with preserved fields
            member = {
                ...existingMember,  // Start with existing member (includes all app-specific fields)
                ...zohoMemberData    // Overwrite with fresh Zoho data
            };
            console.log('[validateUser] ‚úÖ Member updated with preserved app fields');
        } else {
            console.log('[validateUser] Creating new Member record');
            
            // Check for default role
            const allRoles = await base44.asServiceRole.entities.Role.list();
            console.log('[validateUser] Total roles in system:', allRoles.length);
            
            const defaultRole = allRoles.find(r => r.is_default === true);
            
            if (defaultRole) {
                console.log('[validateUser] ‚úÖ Default role found:', defaultRole.name, '(ID:', defaultRole.id + ')');
                zohoMemberData.role_id = defaultRole.id;
            } else {
                console.warn('[validateUser] ‚ö†Ô∏è No default role found, member will have no role assigned');
            }
            
            member = await base44.asServiceRole.entities.Member.create(zohoMemberData);
            console.log('[validateUser] ‚úÖ Member created with ID:', member.id);
        }
        
        console.log('\n[validateUser] ‚úÖ SUCCESS: Member validation complete');
        console.log('[validateUser] Returning complete user data with all fields...');
        console.log('[validateUser] Final member object includes:');
        console.log('[validateUser]   - page_tours_seen:', JSON.stringify(member.page_tours_seen || {}));
        console.log('[validateUser]   - role_id:', member.role_id || 'null');
        console.log('[validateUser]   - member_excluded_features:', JSON.stringify(member.member_excluded_features || []));
        console.log('[validateUser]   - has_seen_onboarding_tour:', member.has_seen_onboarding_tour || false);
        console.log('[validateUser]   - login_enabled:', member.login_enabled ?? true);
        console.log('========================================\n\n');
        
        return Response.json({
            success: true,
            user: {
                email: member.email,
                first_name: member.first_name,
                last_name: member.last_name,
                organization_id: organizationId,
                organization_name: organizationName,
                training_fund_balance: trainingFundBalance,
                purchase_order_enabled: purchaseOrderEnabled,
                program_ticket_balances: programTicketBalances,
                role_id: member.role_id || null,
                member_excluded_features: member.member_excluded_features || [],
                has_seen_onboarding_tour: member.has_seen_onboarding_tour || false,
                page_tours_seen: member.page_tours_seen || {},
                is_team_member: false
            }
        });
        
    } catch (error) {
        console.error('\n[validateUser] ‚ùå‚ùå‚ùå FATAL ERROR ‚ùå‚ùå‚ùå');
        console.error('[validateUser] Error message:', error.message);
        console.error('[validateUser] Error stack:', error.stack);
        console.error('[validateUser] Error name:', error.name);
        console.log('========================================\n\n');
        
        return Response.json({ 
            success: false,
            error: 'Unable to validate user. Please try again later.',
            details: error.message 
        }, { status: 500 });
    }
});