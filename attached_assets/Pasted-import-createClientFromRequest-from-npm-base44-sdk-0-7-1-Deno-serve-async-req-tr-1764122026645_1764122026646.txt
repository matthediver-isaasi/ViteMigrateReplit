import { createClientFromRequest } from 'npm:@base44/sdk@0.7.1';

Deno.serve(async (req) => {
    try {
        const base44 = createClientFromRequest(req);
        
        // Parse the job posting data (includes memberEmail)
        const jobData = await req.json();
        const { memberEmail, ...postingData } = jobData;

        if (!memberEmail) {
            console.error('[createJobPostingMember] No member email provided');
            return Response.json({ 
                success: false, 
                error: 'Member email is required' 
            }, { status: 400 });
        }

        console.log('[createJobPostingMember] Creating job posting for member:', memberEmail);

        // Get member information using service role
        const allMembers = await base44.asServiceRole.entities.Member.list();
        const member = allMembers.find(m => m.email === memberEmail);
        
        if (!member) {
            console.error('[createJobPostingMember] Member not found for email:', memberEmail);
            return Response.json({ 
                success: false, 
                error: 'Member record not found. Please ensure you are logged in with your member email address.' 
            }, { status: 404 });
        }

        console.log('[createJobPostingMember] Found member:', member.id, 'organization_id:', member.organization_id);

        // Get organization information
        let organizationName = null;
        if (member.organization_id) {
            const allOrgs = await base44.asServiceRole.entities.Organization.list();
            const org = allOrgs.find(o => o.id === member.organization_id);
            if (org) {
                organizationName = org.name;
                console.log('[createJobPostingMember] Found organization:', organizationName);
            } else {
                console.warn('[createJobPostingMember] Organization not found for ID:', member.organization_id);
            }
        } else {
            console.log('[createJobPostingMember] Member has no organization_id');
        }

        // Create the job posting
        const jobPosting = await base44.asServiceRole.entities.JobPosting.create({
            title: postingData.title,
            description: postingData.description,
            company_name: postingData.company_name,
            company_logo_url: postingData.company_logo_url || null,
            location: postingData.location,
            salary_range: postingData.salary_range || null,
            job_type: postingData.job_type || null,
            hours: postingData.hours || null,
            closing_date: postingData.closing_date,
            application_method: postingData.application_method,
            application_value: postingData.application_value,
            contact_email: memberEmail,
            contact_name: postingData.contact_name,
            posted_by_member_id: member.id,
            posted_by_organization_id: member.organization_id || null,
            posted_by_organization_name: organizationName,
            is_member_post: true,
            status: 'pending_approval',
            payment_status: 'N/A',
            attachment_urls: postingData.attachment_urls || [],
            attachment_names: postingData.attachment_names || []
        });

        console.log('[createJobPostingMember] Job posting created successfully:', jobPosting.id);

        return Response.json({ 
            success: true, 
            job_id: jobPosting.id 
        });

    } catch (error) {
        console.error('[createJobPostingMember] Error:', error);
        return Response.json({ 
            success: false, 
            error: error.message || 'Failed to create job posting' 
        }, { status: 500 });
    }
});