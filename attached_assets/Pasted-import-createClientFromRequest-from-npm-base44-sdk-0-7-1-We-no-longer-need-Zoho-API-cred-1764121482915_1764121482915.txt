import { createClientFromRequest } from 'npm:@base44/sdk@0.7.1';

// We no longer need Zoho API credentials here to fetch order details,
// as the webhook now signals individual order cancellations directly.
// Removing the getValidAccessToken function and related ZOHO environment variables.

Deno.serve(async (req) => {
    try {
        const base44 = createClientFromRequest(req);
        const webhookData = await req.json();

        console.log("=== BACKSTAGE CANCELLATION WEBHOOK RECEIVED ===");
        console.log("Full Payload:", JSON.stringify(webhookData, null, 2));
        console.log("==============================================");

        // Extract key fields from the webhook
        const action = webhookData.action;
        const resourceType = webhookData.resource;
        const backstageOrderId = webhookData.resource_id; // This is now the ID of the single-ticket order
        
        // Log extracted fields for debugging
        console.log("Extracted Fields:");
        console.log("  - Action:", action);
        console.log("  - Resource:", resourceType);
        console.log("  - Backstage Order ID:", backstageOrderId);

        // This webhook is now designed to exclusively handle EVENTORDER cancellations
        // where each order represents a single ticket.
        if (action === 'cancel' && resourceType === 'eventorder') {
            console.log("*** SINGLE TICKET ORDER CANCELLATION DETECTED ***");

            if (!backstageOrderId) {
                console.error("Missing backstage order ID in cancellation webhook payload");
                return Response.json({ 
                    success: false, 
                    error: "Missing order ID in payload" 
                }, { status: 400 });
            }

            // Find the *single* booking with this specific backstage_order_id
            const allBookings = await base44.asServiceRole.entities.Booking.list();
            const bookingToCancel = allBookings.find(b => 
                b.backstage_order_id === backstageOrderId && 
                b.status !== 'cancelled'
            );

            if (bookingToCancel) {
                await base44.asServiceRole.entities.Booking.update(bookingToCancel.id, {
                    status: 'cancelled'
                });
                console.log(`âœ“ Booking ${bookingToCancel.id} (${bookingToCancel.attendee_email}) updated to cancelled due to Backstage order cancellation.`);
                
                return Response.json({ 
                    success: true, 
                    message: `Successfully cancelled booking for Backstage Order ID: ${backstageOrderId}`,
                    booking_id: bookingToCancel.id
                });
            } else {
                console.warn(`No active booking found for Backstage Order ID: ${backstageOrderId}. It may have already been cancelled or does not exist in the system.`);
                return Response.json({ 
                    success: true, // Still a success from webhook's perspective, just nothing to update
                    message: `No active booking found for Backstage Order ID: ${backstageOrderId}`
                });
            }

        } else {
            console.log(`Webhook received but not an 'eventorder' cancellation. Action: ${action}, Resource: ${resourceType}`);
            return Response.json({ 
                success: true, 
                message: "Webhook received but not an expected order cancellation event"
            });
        }

    } catch (error) {
        console.error("Error processing Backstage cancellation webhook:", error);
        return Response.json({ 
            success: false, 
            error: error.message 
        }, { status: 500 });
    }
});