
import { createClientFromRequest } from 'npm:@base44/sdk@0.7.1';

Deno.serve(async (req) => {
    try {
        const base44 = createClientFromRequest(req);
        
        // Parse JSON body
        const { eventId, imageBase64, fileName, userEmail, description, backstagePublicUrl } = await req.json();
        
        if (!eventId) {
            return Response.json({ 
                error: 'Event ID is required' 
            }, { status: 400 });
        }

        if (!userEmail) {
            return Response.json({ 
                error: 'User email is required' 
            }, { status: 400 });
        }

        console.log('[updateEventImage] Processing request for user:', userEmail);

        // Check if user is an admin (check both Member and TeamMember entities)
        let isAdmin = false;
        
        // Check Member entity
        const allMembers = await base44.asServiceRole.entities.Member.list();
        const member = allMembers.find(m => m.email === userEmail);
        
        if (member && member.role_id) {
            const allRoles = await base44.asServiceRole.entities.Role.list();
            const role = allRoles.find(r => r.id === member.role_id);
            isAdmin = role?.is_admin || false;
        }
        
        // If not found in Member, check TeamMember entity
        if (!isAdmin) {
            const allTeamMembers = await base44.asServiceRole.entities.TeamMember.list();
            const teamMember = allTeamMembers.find(tm => tm.email === userEmail);
            
            if (teamMember && teamMember.role_id) {
                const allRoles = await base44.asServiceRole.entities.Role.list();
                const role = allRoles.find(r => r.id === teamMember.role_id);
                isAdmin = role?.is_admin || false;
            }
        }
        
        if (!isAdmin) {
            console.log('[updateEventImage] User is not admin:', userEmail);
            return Response.json({ 
                error: 'Admin privileges required' 
            }, { status: 403 });
        }

        console.log('[updateEventImage] User verified as admin, proceeding with update');
        
        // Prepare update payload
        const updatePayload = {};
        
        // Handle image upload if provided
        if (imageBase64) {
            // Convert base64 to blob for upload
            const base64Data = imageBase64.split(',')[1]; // Remove data:image/...;base64, prefix
            const binaryData = Uint8Array.from(atob(base64Data), c => c.charCodeAt(0));
            const blob = new Blob([binaryData]);
            
            // Create a File object from the blob
            const file = new File([blob], fileName || 'event-image.jpg', { 
                type: imageBase64.split(';')[0].split(':')[1] 
            });
            
            // Upload the image
            const uploadResponse = await base44.integrations.Core.UploadFile({
                file: file
            });
            
            if (!uploadResponse.file_url) {
                return Response.json({ 
                    error: 'Failed to upload image' 
                }, { status: 500 });
            }

            console.log('[updateEventImage] Image uploaded successfully:', uploadResponse.file_url);
            updatePayload.image_url = uploadResponse.file_url;
        }
        
        // Handle description update if provided
        if (description !== undefined && description !== null) {
            updatePayload.description = description;
            console.log('[updateEventImage] Updating description');
        }
        
        // Handle backstage public URL update if provided
        if (backstagePublicUrl !== undefined && backstagePublicUrl !== null) {
            updatePayload.backstage_public_url = backstagePublicUrl;
            console.log('[updateEventImage] Updating backstage public URL');
        }
        
        // Update the event
        if (Object.keys(updatePayload).length > 0) {
            await base44.asServiceRole.entities.Event.update(eventId, updatePayload);
            console.log('[updateEventImage] Event updated successfully');
        }
        
        return Response.json({
            success: true,
            ...updatePayload
        });
        
    } catch (error) {
        console.error('[updateEventImage] error:', error);
        return Response.json({ 
            error: 'Failed to update event',
            message: error.message 
        }, { status: 500 });
    }
});
