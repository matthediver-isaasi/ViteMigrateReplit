import { createClientFromRequest } from 'npm:@base44/sdk@0.8.4';
import JSZip from 'npm:jszip@3.10.1';

// Helper function to convert array of objects to CSV
function arrayToCSV(data) {
  if (!data || data.length === 0) return '';
  
  // Get all unique keys from all objects
  const allKeys = new Set();
  data.forEach(obj => {
    Object.keys(obj).forEach(key => allKeys.add(key));
  });
  
  const headers = Array.from(allKeys);
  
  // Create CSV header row
  const csvRows = [headers.join(',')];
  
  // Create data rows
  data.forEach(obj => {
    const values = headers.map(header => {
      const value = obj[header];
      
      // Handle different types
      if (value === null || value === undefined) {
        return '';
      }
      
      if (typeof value === 'object') {
        // Convert objects/arrays to JSON string
        return `"${JSON.stringify(value).replace(/"/g, '""')}"`;
      }
      
      if (typeof value === 'string') {
        // Escape quotes and wrap in quotes if contains comma or newline
        if (value.includes(',') || value.includes('\n') || value.includes('"')) {
          return `"${value.replace(/"/g, '""')}"`;
        }
      }
      
      return value;
    });
    
    csvRows.push(values.join(','));
  });
  
  return csvRows.join('\n');
}

Deno.serve(async (req) => {
  try {
    const base44 = createClientFromRequest(req);
    
    // Get member email from request body
    const { memberEmail } = await req.json();
    
    if (!memberEmail) {
      return Response.json({ error: 'Member email required' }, { status: 400 });
    }
    
    console.log('Validating member:', memberEmail);
    
    // Check both Member and TeamMember entities
    const [roles, members, teamMembers] = await Promise.all([
      base44.asServiceRole.entities.Role.list(),
      base44.asServiceRole.entities.Member.list(),
      base44.asServiceRole.entities.TeamMember.list()
    ]);
    
    // Find the member/team member
    const member = members.find(m => m.email === memberEmail);
    const teamMember = teamMembers.find(tm => tm.email === memberEmail);
    
    console.log('Member found:', !!member, 'Team member found:', !!teamMember);
    
    let userRole = null;
    
    if (member?.role_id) {
      userRole = roles.find(r => r.id === member.role_id);
    } else if (teamMember?.role_id) {
      userRole = roles.find(r => r.id === teamMember.role_id);
    }
    
    console.log('User role:', userRole?.name, 'is_admin:', userRole?.is_admin);
    
    if (!userRole || !userRole.is_admin) {
      console.log('Access denied - not an admin');
      return Response.json({ error: 'Admin access required' }, { status: 403 });
    }
    
    console.log('Admin access confirmed, starting export...');
    
    // List of all entity names to export
    const entityNames = [
      'Member', 'Organization', 'Event', 'Booking', 'ProgramTicketTransaction',
      'MagicLink', 'OrganizationContact', 'Program', 'Voucher', 'BlogPost',
      'Role', 'TeamMember', 'DiscountCode', 'DiscountCodeUsage', 'SystemSettings',
      'Resource', 'ResourceCategory', 'ResourceFolder', 'FileRepository', 'FileRepositoryFolder',
      'JobPosting', 'PageBanner', 'IEditPage', 'IEditPageElement', 'IEditElementTemplate',
      'NavigationItem', 'ArticleCategory', 'ArticleComment', 'CommentReaction',
      'ArticleReaction', 'ArticleView', 'ButtonStyle', 'Award', 'OfflineAward',
      'OfflineAwardAssignment', 'WallOfFameSection', 'WallOfFameCategory', 'WallOfFamePerson',
      'Floater', 'Form', 'FormSubmission', 'TourGroup', 'TourStep', 'NewsPost',
      'ResourceAuthorSettings', 'ZohoToken', 'XeroToken'
    ];
    
    // Create a new ZIP file
    const zip = new JSZip();
    
    // Export each entity
    for (const entityName of entityNames) {
      try {
        // Fetch all records for this entity
        const records = await base44.asServiceRole.entities[entityName].list();
        
        if (records && records.length > 0) {
          // Convert to CSV
          const csv = arrayToCSV(records);
          
          // Add to ZIP
          zip.file(`${entityName}.csv`, csv);
          
          console.log(`Exported ${records.length} records from ${entityName}`);
        }
      } catch (error) {
        console.warn(`Failed to export ${entityName}:`, error.message);
        // Continue with other entities even if one fails
      }
    }
    
    // Generate ZIP file
    const zipBlob = await zip.generateAsync({ type: 'uint8array' });
    
    // Create a file name with timestamp
    const timestamp = new Date().toISOString().replace(/[:.]/g, '-').split('T')[0];
    const fileName = `data-export-${timestamp}.zip`;
    
    // Create a File object (proper format for upload)
    const file = new File([zipBlob], fileName, { type: 'application/zip' });
    
    // Upload to private storage
    const uploadResult = await base44.asServiceRole.integrations.Core.UploadPrivateFile({
      file: file
    });
    
    // Create signed URL (expires in 1 hour)
    const signedUrlResult = await base44.asServiceRole.integrations.Core.CreateFileSignedUrl({
      file_uri: uploadResult.file_uri,
      expires_in: 3600 // 1 hour
    });
    
    return Response.json({
      success: true,
      download_url: signedUrlResult.signed_url,
      file_name: fileName,
      expires_in: 3600
    });
    
  } catch (error) {
    console.error('Export error:', error);
    return Response.json({ 
      error: 'Failed to export data', 
      details: error.message 
    }, { status: 500 });
  }
});