import { createClientFromRequest } from 'npm:@base44/sdk@0.7.1';

const ZOHO_CLIENT_ID = Deno.env.get("ZOHO_CLIENT_ID");
const ZOHO_CLIENT_SECRET = Deno.env.get("ZOHO_CLIENT_SECRET");
const ZOHO_CRM_API_DOMAIN = Deno.env.get("ZOHO_CRM_API_DOMAIN");
const REDIRECT_URI = "https://agcas.base44.app/api/functions/zohoOAuthCallback";

// Convert API domain to accounts domain
function getAccountsDomain(apiDomain) {
    if (apiDomain.includes('.zohoapis.eu')) {
        return 'https://accounts.zoho.eu';
    } else if (apiDomain.includes('.zohoapis.com.au')) {
        return 'https://accounts.zoho.com.au';
    } else {
        return 'https://accounts.zoho.com';
    }
}

Deno.serve(async (req) => {
    try {
        const base44 = createClientFromRequest(req);
        const url = new URL(req.url);
        const code = url.searchParams.get('code');
        const error = url.searchParams.get('error');

        if (error) {
            return new Response(`
                <html>
                    <body style="font-family: system-ui; padding: 40px; text-align: center;">
                        <h1 style="color: #dc2626;">Authentication Error</h1>
                        <p>Failed to authenticate with Zoho: ${error}</p>
                        <button onclick="window.close()" style="margin-top: 20px; padding: 10px 20px; background: #2563eb; color: white; border: none; border-radius: 6px; cursor: pointer;">
                            Close Window
                        </button>
                    </body>
                </html>
            `, {
                status: 400,
                headers: { 'Content-Type': 'text/html' }
            });
        }

        if (!code) {
            return Response.json({ error: 'No authorization code provided' }, { status: 400 });
        }

        const accountsDomain = getAccountsDomain(ZOHO_CRM_API_DOMAIN);

        // Exchange authorization code for access token
        const tokenResponse = await fetch(`${accountsDomain}/oauth/v2/token`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: new URLSearchParams({
                grant_type: 'authorization_code',
                client_id: ZOHO_CLIENT_ID,
                client_secret: ZOHO_CLIENT_SECRET,
                redirect_uri: REDIRECT_URI,
                code: code,
            }).toString(),
        });

        const tokenData = await tokenResponse.json();

        if (!tokenResponse.ok || tokenData.error) {
            return new Response(`
                <html>
                    <body style="font-family: system-ui; padding: 40px; text-align: center;">
                        <h1 style="color: #dc2626;">Token Exchange Failed</h1>
                        <p>Error: ${JSON.stringify(tokenData)}</p>
                        <button onclick="window.close()" style="margin-top: 20px; padding: 10px 20px; background: #2563eb; color: white; border: none; border-radius: 6px; cursor: pointer;">
                            Close Window
                        </button>
                    </body>
                </html>
            `, {
                status: 400,
                headers: { 'Content-Type': 'text/html' }
            });
        }

        // Calculate expiration time
        const expiresAt = new Date(Date.now() + (tokenData.expires_in * 1000)).toISOString();

        // Store tokens using service role
        const existingTokens = await base44.asServiceRole.entities.ZohoToken.list();
        
        if (existingTokens.length > 0) {
            await base44.asServiceRole.entities.ZohoToken.update(existingTokens[0].id, {
                access_token: tokenData.access_token,
                refresh_token: tokenData.refresh_token,
                expires_at: expiresAt,
                token_type: tokenData.token_type || 'Bearer',
            });
        } else {
            await base44.asServiceRole.entities.ZohoToken.create({
                access_token: tokenData.access_token,
                refresh_token: tokenData.refresh_token,
                expires_at: expiresAt,
                token_type: tokenData.token_type || 'Bearer',
            });
        }

        return new Response(`
            <html>
                <head>
                    <style>
                        body {
                            font-family: system-ui;
                            padding: 40px;
                            text-align: center;
                            background: linear-gradient(to br, #f8fafc, #eff6ff);
                        }
                        .success { color: #16a34a; margin-bottom: 10px; }
                        button {
                            margin-top: 20px;
                            padding: 12px 24px;
                            background: #2563eb;
                            color: white;
                            border: none;
                            border-radius: 6px;
                            cursor: pointer;
                            font-size: 16px;
                        }
                        button:hover { background: #1d4ed8; }
                    </style>
                </head>
                <body>
                    <h1 class="success">âœ“ Authentication Successful</h1>
                    <p>Your Zoho account has been connected successfully.</p>
                    <p style="font-size: 14px; color: #64748b;">You can now close this window.</p>
                    <button onclick="window.close()">Close Window</button>
                    <script>
                        setTimeout(() => window.close(), 3000);
                    </script>
                </body>
            </html>
        `, {
            headers: { 'Content-Type': 'text/html' },
            status: 200
        });

    } catch (error) {
        return Response.json({ error: error.message }, { status: 500 });
    }
});