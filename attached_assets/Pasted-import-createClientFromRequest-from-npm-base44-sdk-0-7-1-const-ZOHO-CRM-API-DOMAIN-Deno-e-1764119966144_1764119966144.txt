import { createClientFromRequest } from 'npm:@base44/sdk@0.7.1';

const ZOHO_CRM_API_DOMAIN = Deno.env.get("ZOHO_CRM_API_DOMAIN");
const ZOHO_CLIENT_ID = Deno.env.get("ZOHO_CLIENT_ID");
const ZOHO_CLIENT_SECRET = Deno.env.get("ZOHO_CLIENT_SECRET");

async function getValidAccessToken(base44) {
    const tokens = await base44.asServiceRole.entities.ZohoToken.list();
    
    if (tokens.length === 0) {
        throw new Error('No Zoho tokens found. Admin needs to authenticate first.');
    }
    
    const token = tokens[0];
    const now = new Date();
    const expiresAt = new Date(token.expires_at);
    
    if (expiresAt > now) {
        return token.access_token;
    }
    
    function getAccountsDomain(apiDomain) {
        if (apiDomain.includes('.zohoapis.eu')) {
            return 'https://accounts.zoho.eu';
        } else if (apiDomain.includes('.zohoapis.com.au')) {
            return 'https://accounts.zoho.com.au';
        } else {
            return 'https://accounts.zoho.com';
        }
    }
    
    const accountsDomain = getAccountsDomain(ZOHO_CRM_API_DOMAIN);
    
    const refreshResponse = await fetch(`${accountsDomain}/oauth/v2/token`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: new URLSearchParams({
            grant_type: 'refresh_token',
            client_id: ZOHO_CLIENT_ID,
            client_secret: ZOHO_CLIENT_SECRET,
            refresh_token: token.refresh_token,
        }),
    });
    
    const refreshData = await refreshResponse.json();
    
    if (refreshData.error) {
        throw new Error(`Failed to refresh token: ${refreshData.error}`);
    }
    
    const newExpiresAt = new Date(Date.now() + (refreshData.expires_in * 1000)).toISOString();
    await base44.asServiceRole.entities.ZohoToken.update(token.id, {
        access_token: refreshData.access_token,
        expires_at: newExpiresAt,
    });
    
    return refreshData.access_token;
}

Deno.serve(async (req) => {
    try {
        const base44 = createClientFromRequest(req);
        const { email } = await req.json();
        
        console.log('[validateMember] Validating member:', email);
        
        if (!email) {
            return Response.json({ 
                error: 'Email is required' 
            }, { status: 400 });
        }
        
        // Step 1: Check if this is a TeamMember first
        const allTeamMembers = await base44.asServiceRole.entities.TeamMember.list();
        const teamMember = allTeamMembers.find(tm => tm.email === email && tm.is_active === true);
        
        if (teamMember) {
            console.log('[validateMember] Found active TeamMember');
            
            return Response.json({
                success: true,
                member: {
                    email: teamMember.email,
                    first_name: teamMember.first_name,
                    last_name: teamMember.last_name,
                    role_id: teamMember.role_id,
                    is_team_member: true,
                    member_excluded_features: [],
                    has_seen_onboarding_tour: true // Team members don't need the tour
                }
            });
        }
        
        console.log('[validateMember] Not a TeamMember, checking Member entity...');
        
        // Step 2: Check Member entity directly
        const allMembers = await base44.asServiceRole.entities.Member.list();
        const member = allMembers.find(m => m.email === email);
        
        if (!member) {
            return Response.json({ 
                success: false,
                error: 'Email not found. Please check your email address or contact support.'
            }, { status: 404 });
        }
        
        console.log('[validateMember] Found Member record');
        
        let organizationId = member.organization_id;
        let organizationName = null;
        let trainingFundBalance = 0;
        let purchaseOrderEnabled = false;
        let programTicketBalances = {};
        
        if (organizationId) {
            const allOrgs = await base44.asServiceRole.entities.Organization.list();
            let org = allOrgs.find(o => o.id === organizationId);
            
            if (!org) {
                org = allOrgs.find(o => o.zoho_account_id === organizationId);
            }
            
            if (org) {
                organizationName = org.name;
                organizationId = org.id;
                trainingFundBalance = org.training_fund_balance || 0;
                purchaseOrderEnabled = org.purchase_order_enabled || false;
                programTicketBalances = org.program_ticket_balances || {};
            }
        }
        
        return Response.json({
            success: true,
            member: {
                email: member.email,
                first_name: member.first_name,
                last_name: member.last_name,
                organization_id: organizationId,
                organization_name: organizationName,
                training_fund_balance: trainingFundBalance,
                purchase_order_enabled: purchaseOrderEnabled,
                program_ticket_balances: programTicketBalances,
                role_id: member.role_id || null,
                member_excluded_features: member.member_excluded_features || [],
                has_seen_onboarding_tour: member.has_seen_onboarding_tour || false,
                is_team_member: false
            }
        });
        
    } catch (error) {
        console.error('[validateMember] ERROR:', error);
        return Response.json({ 
            success: false,
            error: 'Unable to validate member. Please try again later.',
            details: error.message 
        }, { status: 500 });
    }
});