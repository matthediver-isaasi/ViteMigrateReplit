import { createClientFromRequest } from 'npm:@base44/sdk@0.7.1';
import Stripe from 'npm:stripe@14.11.0';
import formData from 'npm:form-data@4.0.0';
import Mailgun from 'npm:mailgun.js@10.2.1';

Deno.serve(async (req) => {
  try {
    const base44 = createClientFromRequest(req);
    const stripe = new Stripe(Deno.env.get('STRIPE_SECRET_KEY'), {
      apiVersion: '2023-10-16',
    });

    const sig = req.headers.get('stripe-signature');
    const body = await req.text();

    let event;
    try {
      // Verify webhook signature
      event = await stripe.webhooks.constructEventAsync(
        body,
        sig,
        Deno.env.get('STRIPE_WEBHOOK_SECRET') || ''
      );
    } catch (err) {
      console.error('Webhook signature verification failed:', err.message);
      return Response.json({ error: 'Webhook signature verification failed' }, { status: 400 });
    }

    // Handle checkout.session.completed event
    if (event.type === 'checkout.session.completed') {
      const session = event.data.object;
      const jobPostingId = session.metadata.job_posting_id;

      if (jobPostingId) {
        // Update job posting status
        await base44.asServiceRole.entities.JobPosting.update(jobPostingId, {
          status: 'pending_approval',
          payment_status: 'paid',
          stripe_payment_intent_id: session.payment_intent
        });

        // Get job posting details
        const jobPostings = await base44.asServiceRole.entities.JobPosting.list();
        const jobPosting = jobPostings.find(j => j.id === jobPostingId);

        if (jobPosting) {
          // Send confirmation email to poster
          const mailgun = new Mailgun(formData);
          const mg = mailgun.client({
            username: 'api',
            key: Deno.env.get('MAILGUN_API_KEY')
          });

          await mg.messages.create(Deno.env.get('MAILGUN_DOMAIN'), {
            from: Deno.env.get('MAILGUN_FROM_EMAIL'),
            to: jobPosting.contact_email,
            subject: 'Job Posting Payment Confirmed - Pending Approval',
            html: `
              <h2>Payment Confirmed!</h2>
              <p>Dear ${jobPosting.contact_name},</p>
              <p>Your payment of £${jobPosting.amount_paid} for the job posting <strong>${jobPosting.title}</strong> at <strong>${jobPosting.company_name}</strong> has been received successfully.</p>
              <p>Your job posting is now pending approval from our team. You'll receive another email once it's approved and live on the job board.</p>
              <p><strong>Job Details:</strong></p>
              <ul>
                <li>Title: ${jobPosting.title}</li>
                <li>Company: ${jobPosting.company_name}</li>
                <li>Location: ${jobPosting.location}</li>
                <li>Type: ${jobPosting.job_type}</li>
              </ul>
              <p>Best regards,<br>AGCAS Team</p>
            `
          });

          // Notify admins
          const adminRoles = await base44.asServiceRole.entities.Role.filter({ is_admin: true });
          const adminRoleIds = adminRoles.map(r => r.id);
          
          if (adminRoleIds.length > 0) {
            const adminMembers = await base44.asServiceRole.entities.Member.list();
            const admins = adminMembers.filter(m => adminRoleIds.includes(m.role_id));
            
            for (const admin of admins) {
              await mg.messages.create(Deno.env.get('MAILGUN_DOMAIN'), {
                from: Deno.env.get('MAILGUN_FROM_EMAIL'),
                to: admin.email,
                subject: 'New Paid Job Posting Awaiting Approval',
                html: `
                  <h2>New Paid Job Posting Submitted</h2>
                  <p>A non-member has paid and submitted a new job posting that requires approval:</p>
                  <p><strong>Job Details:</strong></p>
                  <ul>
                    <li>Title: ${jobPosting.title}</li>
                    <li>Company: ${jobPosting.company_name}</li>
                    <li>Location: ${jobPosting.location}</li>
                    <li>Posted by: ${jobPosting.contact_name} (${jobPosting.contact_email})</li>
                    <li>Amount Paid: £${jobPosting.amount_paid}</li>
                  </ul>
                  <p>Please log in to the admin portal to review and approve this posting.</p>
                `
              });
            }
          }
        }
      }
    }

    return Response.json({ received: true });

  } catch (error) {
    console.error('Error processing webhook:', error);
    return Response.json({ error: error.message }, { status: 500 });
  }
});