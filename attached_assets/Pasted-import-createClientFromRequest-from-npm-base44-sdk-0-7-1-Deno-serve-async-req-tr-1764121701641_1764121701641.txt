import { createClientFromRequest } from 'npm:@base44/sdk@0.7.1';

Deno.serve(async (req) => {
    try {
        const base44 = createClientFromRequest(req);
        
        // Parse JSON body
        const { 
            programId, 
            imageBase64, 
            fileName, 
            userEmail, 
            description, 
            offerType,
            bogoBuyQuantity,
            bogoGetFreeQuantity,
            bogoLogicType,
            bulkDiscountThreshold,
            bulkDiscountPercentage
        } = await req.json();
        
        if (!programId) {
            return Response.json({ 
                error: 'Program ID is required' 
            }, { status: 400 });
        }

        if (!userEmail) {
            return Response.json({ 
                error: 'User email is required' 
            }, { status: 400 });
        }

        console.log('[updateProgramDetails] Processing request for user:', userEmail);

        // Check if user is an admin (check both Member and TeamMember entities)
        let isAdmin = false;
        
        // Check Member entity
        const allMembers = await base44.asServiceRole.entities.Member.list();
        const member = allMembers.find(m => m.email === userEmail);
        
        if (member && member.role_id) {
            const allRoles = await base44.asServiceRole.entities.Role.list();
            const role = allRoles.find(r => r.id === member.role_id);
            isAdmin = role?.is_admin || false;
        }
        
        // If not found in Member, check TeamMember entity
        if (!isAdmin) {
            const allTeamMembers = await base44.asServiceRole.entities.TeamMember.list();
            const teamMember = allTeamMembers.find(tm => tm.email === userEmail);
            
            if (teamMember && teamMember.role_id) {
                const allRoles = await base44.asServiceRole.entities.Role.list();
                const role = allRoles.find(r => r.id === teamMember.role_id);
                isAdmin = role?.is_admin || false;
            }
        }
        
        if (!isAdmin) {
            console.log('[updateProgramDetails] User is not admin:', userEmail);
            return Response.json({ 
                error: 'Admin privileges required' 
            }, { status: 403 });
        }

        console.log('[updateProgramDetails] User verified as admin, proceeding with update');
        
        // Prepare update payload
        const updatePayload = {};
        
        // Handle image upload if provided
        if (imageBase64) {
            // Convert base64 to blob for upload
            const base64Data = imageBase64.split(',')[1]; // Remove data:image/...;base64, prefix
            const binaryData = Uint8Array.from(atob(base64Data), c => c.charCodeAt(0));
            const blob = new Blob([binaryData]);
            
            // Create a File object from the blob
            const file = new File([blob], fileName || 'program-image.jpg', { 
                type: imageBase64.split(';')[0].split(':')[1] 
            });
            
            // Upload the image
            const uploadResponse = await base44.integrations.Core.UploadFile({
                file: file
            });
            
            if (!uploadResponse.file_url) {
                return Response.json({ 
                    error: 'Failed to upload image' 
                }, { status: 500 });
            }

            console.log('[updateProgramDetails] Image uploaded successfully:', uploadResponse.file_url);
            updatePayload.image_url = uploadResponse.file_url;
        }
        
        // Handle description update if provided
        if (description !== undefined && description !== null) {
            updatePayload.description = description;
            console.log('[updateProgramDetails] Updating description');
        }
        
        // Handle offer type and related fields
        if (offerType !== undefined && offerType !== null) {
            updatePayload.offer_type = offerType;
            console.log('[updateProgramDetails] Updating offer type to:', offerType);
            
            if (offerType === 'bogo') {
                // Set BOGO fields
                if (bogoBuyQuantity !== undefined) updatePayload.bogo_buy_quantity = bogoBuyQuantity;
                if (bogoGetFreeQuantity !== undefined) updatePayload.bogo_get_free_quantity = bogoGetFreeQuantity;
                if (bogoLogicType !== undefined) updatePayload.bogo_logic_type = bogoLogicType;
                
                // Clear bulk discount fields
                updatePayload.bulk_discount_threshold = null;
                updatePayload.bulk_discount_percentage = null;
                
                console.log('[updateProgramDetails] BOGO offer configured');
            } else if (offerType === 'bulk_discount') {
                // Set bulk discount fields
                if (bulkDiscountThreshold !== undefined) updatePayload.bulk_discount_threshold = bulkDiscountThreshold;
                if (bulkDiscountPercentage !== undefined) updatePayload.bulk_discount_percentage = bulkDiscountPercentage;
                
                // Clear BOGO fields
                updatePayload.bogo_buy_quantity = null;
                updatePayload.bogo_get_free_quantity = null;
                updatePayload.bogo_logic_type = null;
                
                console.log('[updateProgramDetails] Bulk discount configured');
            } else {
                // Clear all offer fields for 'none'
                updatePayload.bogo_buy_quantity = null;
                updatePayload.bogo_get_free_quantity = null;
                updatePayload.bogo_logic_type = null;
                updatePayload.bulk_discount_threshold = null;
                updatePayload.bulk_discount_percentage = null;
                
                console.log('[updateProgramDetails] All offers cleared');
            }
        }
        
        // Update the program
        if (Object.keys(updatePayload).length > 0) {
            await base44.asServiceRole.entities.Program.update(programId, updatePayload);
            console.log('[updateProgramDetails] Program updated successfully');
        }
        
        return Response.json({
            success: true,
            ...updatePayload
        });
        
    } catch (error) {
        console.error('[updateProgramDetails] error:', error);
        return Response.json({ 
            error: 'Failed to update program',
            message: error.message 
        }, { status: 500 });
    }
});