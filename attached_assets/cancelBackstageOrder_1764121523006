import { createClientFromRequest } from 'npm:@base44/sdk@0.7.1';

const ZOHO_CLIENT_ID = Deno.env.get("ZOHO_CLIENT_ID");
const ZOHO_CLIENT_SECRET = Deno.env.get("ZOHO_CLIENT_SECRET");
const ZOHO_CRM_API_DOMAIN = Deno.env.get("ZOHO_CRM_API_DOMAIN");

function getAccountsDomain(apiDomain) {
    if (apiDomain.includes('.zohoapis.eu')) {
        return 'https://accounts.zoho.eu';
    } else if (apiDomain.includes('.zohoapis.com.au')) {
        return 'https://accounts.zoho.com.au';
    } else {
        return 'https://accounts.zoho.com';
    }
}

async function getValidAccessToken(base44) {
    const tokens = await base44.asServiceRole.entities.ZohoToken.list();
    if (tokens.length === 0) {
        throw new Error('No Zoho tokens found');
    }
    
    const token = tokens[0];
    if (new Date(token.expires_at) > new Date()) {
        return token.access_token;
    }
    
    const accountsDomain = getAccountsDomain(ZOHO_CRM_API_DOMAIN || 'https://www.zohoapis.com');
    const refreshResponse = await fetch(`${accountsDomain}/oauth/v2/token`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: new URLSearchParams({
            grant_type: 'refresh_token',
            client_id: ZOHO_CLIENT_ID || '',
            client_secret: ZOHO_CLIENT_SECRET || '',
            refresh_token: token.refresh_token,
        }),
    });
    
    const refreshData = await refreshResponse.json();
    if (refreshData.error) {
        throw new Error(`Failed to refresh Zoho token: ${refreshData.error_description || refreshData.error}`);
    }
    
    await base44.asServiceRole.entities.ZohoToken.update(token.id, {
        access_token: refreshData.access_token,
        expires_at: new Date(Date.now() + refreshData.expires_in * 1000).toISOString(),
    });
    
    return refreshData.access_token;
}

Deno.serve(async (req) => {
    try {
        const base44 = createClientFromRequest(req);
        const { orderId, cancelReason = "Cancelled by member" } = await req.json();
        
        console.log('=== CANCEL BACKSTAGE ORDER DISCOVERY (EXPANDED) ===');
        console.log('Order ID:', orderId);
        console.log('Cancel Reason:', cancelReason);
        
        if (!orderId) {
            return Response.json({ 
                success: false,
                error: 'Missing required parameter: orderId' 
            }, { status: 400 });
        }

        // Step 1: Find the booking with this backstage_order_id to get the event_id
        const allBookings = await base44.asServiceRole.entities.Booking.list();
        const booking = allBookings.find(b => b.backstage_order_id === orderId);
        
        if (!booking) {
            console.error('No booking found with backstage_order_id:', orderId);
            return Response.json({ 
                success: false,
                error: 'No booking found with this Backstage order ID' 
            }, { status: 404 });
        }

        console.log('Found booking:', booking.id);
        console.log('Event ID:', booking.event_id);

        // Step 2: Get the event to find the backstage_event_id
        const allEvents = await base44.asServiceRole.entities.Event.list();
        const event = allEvents.find(e => e.id === booking.event_id);
        
        if (!event || !event.backstage_event_id) {
            console.error('Event not found or missing backstage_event_id');
            return Response.json({ 
                success: false,
                error: 'Event not found or missing Backstage event ID' 
            }, { status: 404 });
        }

        console.log('Backstage Event ID:', event.backstage_event_id);

        // Step 3: Get access token
        const accessToken = await getValidAccessToken(base44);
        console.log('Access token obtained');

        const portalId = "20108049755";
        const baseUrl = "https://www.zohoapis.eu/backstage/v3";
        const orderUrl = `${baseUrl}/portals/${portalId}/events/${event.backstage_event_id}/orders/${orderId}`;
        
        console.log('Base Order URL:', orderUrl);

        const attempts = [];

        // ATTEMPT 0: GET the order to see what fields/actions are available
        console.log('\n--- ATTEMPT 0: GET order details ---');
        try {
            const response0 = await fetch(orderUrl, {
                method: 'GET',
                headers: {
                    'Authorization': `Zoho-oauthtoken ${accessToken}`
                }
            });
            
            const responseText0 = await response0.text();
            console.log('Response Status:', response0.status);
            console.log('Response Body:', responseText0);
            
            attempts.push({
                method: 'GET',
                url: orderUrl,
                body: null,
                status: response0.status,
                response: responseText0,
                success: response0.ok,
                note: 'Checking order structure for available actions'
            });
        } catch (error) {
            console.error('ATTEMPT 0 Error:', error.message);
            attempts.push({
                method: 'GET',
                url: orderUrl,
                error: error.message
            });
        }

        // ATTEMPT 1: PUT request with status update
        console.log('\n--- ATTEMPT 1: PUT request with status ---');
        try {
            const putBody = {
                status: 'cancelled',
                cancel_reason: cancelReason
            };
            console.log('Body:', JSON.stringify(putBody));
            
            const response1 = await fetch(orderUrl, {
                method: 'PUT',
                headers: {
                    'Authorization': `Zoho-oauthtoken ${accessToken}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(putBody)
            });
            
            const responseText1 = await response1.text();
            console.log('Response Status:', response1.status);
            console.log('Response Body:', responseText1);
            
            attempts.push({
                method: 'PUT',
                url: orderUrl,
                body: putBody,
                status: response1.status,
                response: responseText1,
                success: response1.ok
            });
            
            if (response1.ok) {
                console.log('✓ SUCCESS with PUT');
                
                await base44.asServiceRole.entities.Booking.update(booking.id, {
                    status: 'cancelled'
                });
                
                return Response.json({
                    success: true,
                    method: 'PUT',
                    message: 'Order cancelled successfully',
                    attempts
                });
            }
        } catch (error) {
            console.error('ATTEMPT 1 Error:', error.message);
            attempts.push({
                method: 'PUT',
                url: orderUrl,
                body: { status: 'cancelled', cancel_reason: cancelReason },
                error: error.message
            });
        }

        // ATTEMPT 2: POST to base order URL (update via POST)
        console.log('\n--- ATTEMPT 2: POST to base URL for update ---');
        try {
            const postBody = {
                status: 'cancelled',
                cancel_reason: cancelReason
            };
            console.log('Body:', JSON.stringify(postBody));
            
            const response2 = await fetch(orderUrl, {
                method: 'POST',
                headers: {
                    'Authorization': `Zoho-oauthtoken ${accessToken}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(postBody)
            });
            
            const responseText2 = await response2.text();
            console.log('Response Status:', response2.status);
            console.log('Response Body:', responseText2);
            
            attempts.push({
                method: 'POST',
                url: orderUrl,
                body: postBody,
                status: response2.status,
                response: responseText2,
                success: response2.ok
            });
            
            if (response2.ok) {
                console.log('✓ SUCCESS with POST to base URL');
                
                await base44.asServiceRole.entities.Booking.update(booking.id, {
                    status: 'cancelled'
                });
                
                return Response.json({
                    success: true,
                    method: 'POST (base URL)',
                    message: 'Order cancelled successfully',
                    attempts
                });
            }
        } catch (error) {
            console.error('ATTEMPT 2 Error:', error.message);
            attempts.push({
                method: 'POST',
                url: orderUrl,
                body: { status: 'cancelled', cancel_reason: cancelReason },
                error: error.message
            });
        }

        // ATTEMPT 3: POST with action parameter in body
        console.log('\n--- ATTEMPT 3: POST with action=cancel in body ---');
        try {
            const postBody = {
                action: 'cancel',
                cancel_reason: cancelReason
            };
            console.log('Body:', JSON.stringify(postBody));
            
            const response3 = await fetch(orderUrl, {
                method: 'POST',
                headers: {
                    'Authorization': `Zoho-oauthtoken ${accessToken}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(postBody)
            });
            
            const responseText3 = await response3.text();
            console.log('Response Status:', response3.status);
            console.log('Response Body:', responseText3);
            
            attempts.push({
                method: 'POST',
                url: orderUrl,
                body: postBody,
                status: response3.status,
                response: responseText3,
                success: response3.ok
            });
            
            if (response3.ok) {
                console.log('✓ SUCCESS with POST action=cancel');
                
                await base44.asServiceRole.entities.Booking.update(booking.id, {
                    status: 'cancelled'
                });
                
                return Response.json({
                    success: true,
                    method: 'POST (action parameter)',
                    message: 'Order cancelled successfully',
                    attempts
                });
            }
        } catch (error) {
            console.error('ATTEMPT 3 Error:', error.message);
            attempts.push({
                method: 'POST',
                url: orderUrl,
                body: { action: 'cancel', cancel_reason: cancelReason },
                error: error.message
            });
        }

        // ATTEMPT 4: Try at tickets level instead of orders
        console.log('\n--- ATTEMPT 4: POST to tickets endpoint ---');
        try {
            const ticketsUrl = `${baseUrl}/portals/${portalId}/events/${event.backstage_event_id}/tickets/${orderId}`;
            console.log('Tickets URL:', ticketsUrl);
            
            const postBody = {
                status: 'cancelled',
                cancel_reason: cancelReason
            };
            
            const response4 = await fetch(ticketsUrl, {
                method: 'POST',
                headers: {
                    'Authorization': `Zoho-oauthtoken ${accessToken}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(postBody)
            });
            
            const responseText4 = await response4.text();
            console.log('Response Status:', response4.status);
            console.log('Response Body:', responseText4);
            
            attempts.push({
                method: 'POST',
                url: ticketsUrl,
                body: postBody,
                status: response4.status,
                response: responseText4,
                success: response4.ok
            });
            
            if (response4.ok) {
                console.log('✓ SUCCESS with tickets endpoint');
                
                await base44.asServiceRole.entities.Booking.update(booking.id, {
                    status: 'cancelled'
                });
                
                return Response.json({
                    success: true,
                    method: 'POST (tickets endpoint)',
                    message: 'Order cancelled successfully',
                    attempts
                });
            }
        } catch (error) {
            console.error('ATTEMPT 4 Error:', error.message);
            attempts.push({
                method: 'POST',
                url: `${baseUrl}/portals/${portalId}/events/${event.backstage_event_id}/tickets/${orderId}`,
                body: { status: 'cancelled', cancel_reason: cancelReason },
                error: error.message
            });
        }

        // ATTEMPT 5: Try with _method parameter (some APIs use this for method override)
        console.log('\n--- ATTEMPT 5: POST with _method=DELETE ---');
        try {
            const postBody = {
                _method: 'DELETE',
                cancel_reason: cancelReason
            };
            console.log('Body:', JSON.stringify(postBody));
            
            const response5 = await fetch(orderUrl, {
                method: 'POST',
                headers: {
                    'Authorization': `Zoho-oauthtoken ${accessToken}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(postBody)
            });
            
            const responseText5 = await response5.text();
            console.log('Response Status:', response5.status);
            console.log('Response Body:', responseText5);
            
            attempts.push({
                method: 'POST',
                url: orderUrl,
                body: postBody,
                status: response5.status,
                response: responseText5,
                success: response5.ok
            });
            
            if (response5.ok) {
                console.log('✓ SUCCESS with _method=DELETE');
                
                await base44.asServiceRole.entities.Booking.update(booking.id, {
                    status: 'cancelled'
                });
                
                return Response.json({
                    success: true,
                    method: 'POST (_method override)',
                    message: 'Order cancelled successfully',
                    attempts
                });
            }
        } catch (error) {
            console.error('ATTEMPT 5 Error:', error.message);
            attempts.push({
                method: 'POST',
                url: orderUrl,
                body: { _method: 'DELETE', cancel_reason: cancelReason },
                error: error.message
            });
        }

        // ATTEMPT 6: Try refund endpoint (cancellation might be via refund)
        console.log('\n--- ATTEMPT 6: POST to refund endpoint ---');
        try {
            const refundUrl = `${orderUrl}/refund`;
            console.log('Refund URL:', refundUrl);
            
            const postBody = {
                cancel_reason: cancelReason,
                refund_amount: 0
            };
            
            const response6 = await fetch(refundUrl, {
                method: 'POST',
                headers: {
                    'Authorization': `Zoho-oauthtoken ${accessToken}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(postBody)
            });
            
            const responseText6 = await response6.text();
            console.log('Response Status:', response6.status);
            console.log('Response Body:', responseText6);
            
            attempts.push({
                method: 'POST',
                url: refundUrl,
                body: postBody,
                status: response6.status,
                response: responseText6,
                success: response6.ok
            });
            
            if (response6.ok) {
                console.log('✓ SUCCESS with refund endpoint');
                
                await base44.asServiceRole.entities.Booking.update(booking.id, {
                    status: 'cancelled'
                });
                
                return Response.json({
                    success: true,
                    method: 'POST (refund endpoint)',
                    message: 'Order cancelled successfully',
                    attempts
                });
            }
        } catch (error) {
            console.error('ATTEMPT 6 Error:', error.message);
            attempts.push({
                method: 'POST',
                url: `${orderUrl}/refund`,
                body: { cancel_reason: cancelReason, refund_amount: 0 },
                error: error.message
            });
        }

        console.log('\n=== ALL ATTEMPTS COMPLETED ===');
        console.log('Summary: All discovery attempts failed or returned errors.');
        console.log('Next step: Consider using Zoho Flow webhook approach');
        
        return Response.json({
            success: false,
            message: 'All cancellation attempts failed. Zoho Flow webhook approach recommended.',
            attempts,
            orderUrl,
            portalId,
            backstageEventId: event.backstage_event_id,
            recommendation: 'Consider creating a Zoho Flow webhook to handle cancellations from iConnect'
        });

    } catch (error) {
        console.error('Fatal error:', error);
        return Response.json({ 
            success: false,
            error: error.message,
            stack: error.stack
        }, { status: 500 });
    }
});