
import { createClientFromRequest } from 'npm:@base44/sdk@0.7.1';

const ZOHO_CRM_API_DOMAIN = Deno.env.get("ZOHO_CRM_API_DOMAIN");
const ZOHO_CLIENT_ID = Deno.env.get("ZOHO_CLIENT_ID");
const ZOHO_CLIENT_SECRET = Deno.env.get("ZOHO_CLIENT_SECRET");

async function getValidAccessToken(base44) {
    const tokens = await base44.asServiceRole.entities.ZohoToken.list();
    if (tokens.length === 0) throw new Error('No tokens');
    
    const token = tokens[0];
    if (new Date(token.expires_at) > new Date()) {
        return token.access_token;
    }
    
    const accountsDomain = ZOHO_CRM_API_DOMAIN.includes('.eu') ? 'https://accounts.zoho.eu' : 'https://accounts.zoho.com';
    const refreshResponse = await fetch(`${accountsDomain}/oauth/v2/token`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: new URLSearchParams({
            grant_type: 'refresh_token',
            client_id: ZOHO_CLIENT_ID,
            client_secret: ZOHO_CLIENT_SECRET,
            refresh_token: token.refresh_token,
        }),
    });
    
    const refreshData = await refreshResponse.json();
    if (refreshData.error) throw new Error(refreshData.error);
    
    await base44.asServiceRole.entities.ZohoToken.update(token.id, {
        access_token: refreshData.access_token,
        expires_at: new Date(Date.now() + refreshData.expires_in * 1000).toISOString(),
    });
    
    return refreshData.access_token;
}

Deno.serve(async (req) => {
    try {
        const base44 = createClientFromRequest(req);
        const { organizationId } = await req.json();
        
        console.log('=== Sync Organization Contacts Started ===');
        console.log('Organization ID:', organizationId);
        
        if (!organizationId) {
            return Response.json({ 
                success: false,
                error: 'Organization ID is required' 
            }, { status: 400 });
        }

        // Get the organization - try by Base44 ID first, then by Zoho Account ID
        const allOrgs = await base44.asServiceRole.entities.Organization.list();
        let org = allOrgs.find(o => o.id === organizationId);
        
        // If not found by Base44 ID, try finding by Zoho Account ID
        if (!org) {
            console.log('Not found by Base44 ID, trying Zoho Account ID...');
            org = allOrgs.find(o => o.zoho_account_id === organizationId);
        }

        console.log('Organization found:', org ? org.name : 'NOT FOUND');
        console.log('Base44 Organization ID:', org?.id);
        console.log('Zoho Account ID:', org?.zoho_account_id);

        if (!org || !org.zoho_account_id) {
            return Response.json({ 
                success: false,
                error: 'Organization not found or not linked to Zoho',
                details: {
                    organizationFound: !!org,
                    zohoAccountId: org?.zoho_account_id
                }
            }, { status: 404 });
        }

        const accessToken = await getValidAccessToken(base44);
        console.log('Access token obtained');
        
        // Fetch all contacts for this organization from Zoho CRM
        let allContacts = [];
        let page = 1;
        const perPage = 200;
        let hasMore = true;

        console.log('Starting to fetch contacts from Zoho...');
        console.log('Searching for contacts with Account Name:', org.name);

        while (hasMore) {
            // Search by the actual Account Name (text), not ID
            const criteria = `(Account_Name:equals:${org.name})`;
            const searchUrl = `${ZOHO_CRM_API_DOMAIN}/crm/v3/Contacts/search?criteria=${encodeURIComponent(criteria)}&page=${page}&per_page=${perPage}`;
            
            console.log(`Fetching page ${page}...`);
            console.log('Search URL:', searchUrl);
            
            const response = await fetch(searchUrl, {
                headers: {
                    'Authorization': `Zoho-oauthtoken ${accessToken}`,
                },
            });

            const responseText = await response.text();
            console.log('Response status:', response.status);
            console.log('Response body:', responseText.substring(0, 500)); // First 500 chars

            if (!response.ok) {
                console.error('Failed to fetch contacts from Zoho');
                console.error('Status:', response.status);
                console.error('Response:', responseText);
                break;
            }

            let data;
            try {
                data = JSON.parse(responseText);
            } catch (e) {
                console.error('Failed to parse JSON response:', e);
                console.error('Response text:', responseText);
                break;
            }
            
            console.log('Contacts in this page:', data.data?.length || 0);
            
            if (data.data && data.data.length > 0) {
                allContacts = allContacts.concat(data.data);
                console.log('Total contacts so far:', allContacts.length);
                
                // Check if there are more pages
                if (data.info && data.info.more_records) {
                    page++;
                } else {
                    hasMore = false;
                }
            } else {
                hasMore = false;
            }
        }

        console.log('Total contacts fetched from Zoho:', allContacts.length);

        if (allContacts.length === 0) {
            console.log('No contacts found for this organization');
            // Still update the sync timestamp even if no contacts found
            await base44.asServiceRole.entities.Organization.update(org.id, {
                contacts_synced_at: new Date().toISOString()
            });
            
            return Response.json({
                success: true,
                synced_count: 0,
                created: 0,
                updated: 0,
                deactivated: 0,
                message: 'No contacts found for this organization'
            });
        }

        // Get existing contacts for this organization
        const existingContacts = await base44.asServiceRole.entities.OrganizationContact.filter({
            organization_id: org.id
        });

        console.log('Existing contacts in Base44:', existingContacts.length);

        const existingByZohoId = {};
        existingContacts.forEach(contact => {
            existingByZohoId[contact.zoho_contact_id] = contact;
        });

        // Prepare contacts to create or update
        const contactsToCreate = [];
        const contactsToUpdate = [];
        const zohoIdsFound = new Set();

        for (const zohoContact of allContacts) {
            zohoIdsFound.add(zohoContact.id);
            
            if (!zohoContact.Email) {
                console.log(`Skipping Zoho contact ID ${zohoContact.id} because it has no email.`);
                continue;
            }
            
            const contactData = {
                organization_id: org.id,
                zoho_contact_id: zohoContact.id,
                email: zohoContact.Email,
                first_name: zohoContact.First_Name || '',
                last_name: zohoContact.Last_Name || '',
                is_active: true,
                last_synced: new Date().toISOString()
            };

            if (existingByZohoId[zohoContact.id]) {
                // Update existing
                contactsToUpdate.push({
                    id: existingByZohoId[zohoContact.id].id,
                    ...contactData
                });
            } else {
                // Create new
                contactsToCreate.push(contactData);
            }
        }

        console.log('Contacts to create:', contactsToCreate.length);
        console.log('Contacts to update:', contactsToUpdate.length);

        // Mark contacts that are no longer in Zoho as inactive
        const contactsToDeactivate = existingContacts.filter(
            c => !zohoIdsFound.has(c.zoho_contact_id) && c.is_active
        );

        console.log('Contacts to deactivate:', contactsToDeactivate.length);

        // Perform bulk operations
        if (contactsToCreate.length > 0) {
            console.log(`Initiating bulk create for ${contactsToCreate.length} contacts...`);
            // console.log('Sample contact to create:', JSON.stringify(contactsToCreate[0], null, 2)); // Keep this line commented for brevity in logs unless needed for debug
            await base44.asServiceRole.entities.OrganizationContact.bulkCreate(contactsToCreate);
            console.log(`${contactsToCreate.length} contacts created successfully.`);
        }

        if (contactsToUpdate.length > 0) {
            console.log(`Initiating updates for ${contactsToUpdate.length} contacts...`);
            for (const contact of contactsToUpdate) {
                console.log(`Updating Base44 contact ID: ${contact.id} (Zoho ID: ${contact.zoho_contact_id}, Email: ${contact.email})`);
                const { id, ...updateData } = contact; // Remove id from the data being sent
                await base44.asServiceRole.entities.OrganizationContact.update(id, updateData);
            }
            console.log(`${contactsToUpdate.length} contacts updated successfully.`);
        }
        

        if (contactsToDeactivate.length > 0) {
            console.log(`Initiating deactivation for ${contactsToDeactivate.length} contacts...`);
            for (const contact of contactsToDeactivate) {
                console.log(`Deactivating Base44 contact ID: ${contact.id} (Zoho ID: ${contact.zoho_contact_id}, Email: ${contact.email})`);
                await base44.asServiceRole.entities.OrganizationContact.update(contact.id, {
                    is_active: false,
                    last_synced: new Date().toISOString()
                });
            }
            console.log(`${contactsToDeactivate.length} contacts deactivated successfully.`);
        }
        
        // Update organization sync timestamp
        await base44.asServiceRole.entities.Organization.update(org.id, {
            contacts_synced_at: new Date().toISOString()
        });
        console.log(`Organization ${org.id} sync timestamp updated.`);

        console.log('=== Sync Complete ===');

        return Response.json({
            success: true,
            synced_count: allContacts.length,
            created: contactsToCreate.length,
            updated: contactsToUpdate.length,
            deactivated: contactsToDeactivate.length
        });

    } catch (error) {
        console.error('=== Sync Error ===');
        console.error('Error message:', error.message);
        console.error('Error stack:', error.stack);
        return Response.json({ 
            success: false,
            error: error.message,
            stack: error.stack
        }, { status: 500 });
    }
});
