import { createClientFromRequest } from 'npm:@base44/sdk@0.8.4';

Deno.serve(async (req) => {
    try {
        const base44 = createClientFromRequest(req);
        const { token } = await req.json();
        
        console.log('[verifyMagicLink] Token received:', token ? 'yes' : 'no');
        
        if (!token) {
            return Response.json({ 
                error: 'Token is required' 
            }, { status: 400 });
        }

        // Find the magic link
        const allLinks = await base44.asServiceRole.entities.MagicLink.list();
        const magicLink = allLinks.find(link => link.token === token);

        if (!magicLink) {
            console.log('[verifyMagicLink] Token not found in database');
            return Response.json({ 
                success: false,
                error: 'Invalid or expired link'
            }, { status: 404 });
        }

        // Check if already used
        if (magicLink.used) {
            console.log('[verifyMagicLink] Token already used');
            return Response.json({ 
                success: false,
                error: 'This link has already been used'
            }, { status: 400 });
        }

        // Check if expired
        if (new Date(magicLink.expires_at) < new Date()) {
            console.log('[verifyMagicLink] Token expired');
            return Response.json({ 
                success: false,
                error: 'This link has expired'
            }, { status: 400 });
        }

        // Mark as used
        await base44.asServiceRole.entities.MagicLink.update(magicLink.id, {
            used: true
        });

        console.log('[verifyMagicLink] Calling validateUser for:', magicLink.email);

        // Validate user and get their data
        const validationResponse = await base44.asServiceRole.functions.invoke('validateUser', { 
            email: magicLink.email 
        });

        console.log('[verifyMagicLink] validateUser response:', validationResponse.data);

        if (!validationResponse.data.success) {
            return Response.json({ 
                success: false,
                error: validationResponse.data.error || 'Failed to load user data'
            }, { status: 403 });
        }

        // Update last_login for Member (not TeamMember)
        const user = validationResponse.data.user;
        if (user && !user.is_team_member && user.email) {
            try {
                const allMembers = await base44.asServiceRole.entities.Member.list();
                const member = allMembers.find(m => m.email === user.email);
                if (member) {
                    await base44.asServiceRole.entities.Member.update(member.id, {
                        last_login: new Date().toISOString()
                    });
                }
            } catch (error) {
                console.warn('[verifyMagicLink] Failed to update last_login:', error.message);
            }
        }

        return Response.json({
            success: true,
            user: validationResponse.data.user
        });

    } catch (error) {
        console.error('[verifyMagicLink] error:', error);
        return Response.json({ 
            success: false,
            error: 'Failed to verify link',
            details: error.message 
        }, { status: 500 });
    }
});