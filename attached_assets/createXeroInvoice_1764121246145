import { createClientFromRequest } from 'npm:@base44/sdk@0.7.1';

const XERO_CLIENT_ID = Deno.env.get("XERO_CLIENT_ID");
const XERO_CLIENT_SECRET = Deno.env.get("XERO_CLIENT_SECRET");

async function getValidAccessToken(base44) {
    const tokens = await base44.asServiceRole.entities.XeroToken.list();
    
    if (tokens.length === 0) {
        throw new Error('No Xero token found. Please authenticate first.');
    }
    
    const token = tokens[0];
    const expiresAt = new Date(token.expires_at);
    const now = new Date();
    const fiveMinutesFromNow = new Date(now.getTime() + 5 * 60 * 1000);
    
    // Token is still valid
    if (expiresAt > fiveMinutesFromNow) {
        return { accessToken: token.access_token, tenantId: token.tenant_id };
    }
    
    // Refresh token
    const tokenResponse = await fetch('https://identity.xero.com/connect/token', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'Authorization': 'Basic ' + btoa(`${XERO_CLIENT_ID}:${XERO_CLIENT_SECRET}`)
        },
        body: new URLSearchParams({
            grant_type: 'refresh_token',
            refresh_token: token.refresh_token,
        }).toString(),
    });
    
    const tokenData = await tokenResponse.json();
    
    if (!tokenResponse.ok || tokenData.error) {
        throw new Error(`Failed to refresh Xero token: ${JSON.stringify(tokenData)}`);
    }
    
    const newExpiresAt = new Date(Date.now() + (tokenData.expires_in * 1000)).toISOString();
    
    await base44.asServiceRole.entities.XeroToken.update(token.id, {
        access_token: tokenData.access_token,
        refresh_token: tokenData.refresh_token,
        expires_at: newExpiresAt,
    });
    
    return { accessToken: tokenData.access_token, tenantId: token.tenant_id };
}

async function findOrCreateContact(accessToken, tenantId, organizationName) {
    // Search for existing contact
    const searchResponse = await fetch(
        `https://api.xero.com/api.xro/2.0/Contacts?where=Name=="${organizationName}"`,
        {
            headers: {
                'Authorization': `Bearer ${accessToken}`,
                'xero-tenant-id': tenantId,
                'Accept': 'application/json'
            }
        }
    );
    
    const searchData = await searchResponse.json();
    
    if (searchData.Contacts && searchData.Contacts.length > 0) {
        return searchData.Contacts[0].ContactID;
    }
    
    // Create new contact
    const createResponse = await fetch('https://api.xero.com/api.xro/2.0/Contacts', {
        method: 'POST',
        headers: {
            'Authorization': `Bearer ${accessToken}`,
            'xero-tenant-id': tenantId,
            'Content-Type': 'application/json',
            'Accept': 'application/json'
        },
        body: JSON.stringify({
            Contacts: [{
                Name: organizationName
            }]
        })
    });
    
    const createData = await createResponse.json();
    
    if (!createResponse.ok || !createData.Contacts || createData.Contacts.length === 0) {
        throw new Error(`Failed to create Xero contact: ${JSON.stringify(createData)}`);
    }
    
    return createData.Contacts[0].ContactID;
}

Deno.serve(async (req) => {
    try {
        const base44 = createClientFromRequest(req);
        
        const { 
            organizationName,
            purchaseOrderNumber,
            programName,
            baseTicketPrice,
            totalCost,
            totalTickets,
            offerDetails,
            discountCode,
            discountType,
            discountValue,
            stripePaymentIntentId
        } = await req.json();
        
        if (!organizationName || !programName || !totalCost || !totalTickets) {
            return Response.json({ 
                error: 'Missing required parameters',
                required: ['organizationName', 'programName', 'totalCost', 'totalTickets']
            }, { status: 400 });
        }
        
        // Get valid Xero token
        const { accessToken, tenantId } = await getValidAccessToken(base44);
        
        // Find or create contact
        const contactId = await findOrCreateContact(accessToken, tenantId, organizationName);
        
        // Calculate unit price (cost per ticket including free ones)
        const unitPrice = (totalCost / totalTickets).toFixed(2);
        
        // Build line description
        let description = `${programName} tickets.\nPrice: £${baseTicketPrice}`;
        if (offerDetails) {
            description += `\nOffer: ${offerDetails}`;
        }
        
        // Add discount code information if present
        if (discountCode) {
            const discountDisplay = discountType === 'percentage' 
                ? `${discountValue}%` 
                : `£${(discountValue || 0).toFixed(2)}`;
            description += `\nDiscount Code: ${discountCode} (${discountDisplay} off)`;
        }
        
        // Add Stripe payment intent ID if present
        if (stripePaymentIntentId) {
            description += `\nStripe Payment ID: ${stripePaymentIntentId}`;
        }
        
        // Create invoice
        const invoicePayload = {
            Invoices: [{
                Type: 'ACCREC',
                Contact: {
                    ContactID: contactId
                },
                Reference: purchaseOrderNumber || '',
                Status: 'DRAFT',
                DueDate: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                LineItems: [{
                    Description: description,
                    Quantity: totalTickets,
                    UnitAmount: parseFloat(unitPrice),
                    AccountCode: '2112',
                    TaxType: 'EXEMPTOUTPUT'
                }]
            }]
        };
        
        const invoiceResponse = await fetch('https://api.xero.com/api.xro/2.0/Invoices', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${accessToken}`,
                'xero-tenant-id': tenantId,
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            },
            body: JSON.stringify(invoicePayload)
        });
        
        const invoiceData = await invoiceResponse.json();
        
        if (!invoiceResponse.ok || !invoiceData.Invoices || invoiceData.Invoices.length === 0) {
            return Response.json({ 
                error: 'Failed to create Xero invoice',
                details: invoiceData
            }, { status: 400 });
        }
        
        const invoice = invoiceData.Invoices[0];
        
        // Fetch PDF from Xero
        const pdfResponse = await fetch(
            `https://api.xero.com/api.xro/2.0/Invoices/${invoice.InvoiceID}`,
            {
                headers: {
                    'Authorization': `Bearer ${accessToken}`,
                    'xero-tenant-id': tenantId,
                    'Accept': 'application/pdf'
                }
            }
        );
        
        if (!pdfResponse.ok) {
            console.error('Failed to fetch invoice PDF from Xero');
            return Response.json({
                success: true,
                invoice_id: invoice.InvoiceID,
                invoice_number: invoice.InvoiceNumber,
                total: invoice.Total,
                status: invoice.Status
            });
        }
        
        // Get PDF as blob
        const pdfBlob = await pdfResponse.blob();
        
        // Convert blob to File for upload
        const pdfFile = new File([pdfBlob], `invoice-${invoice.InvoiceNumber}.pdf`, { 
            type: 'application/pdf' 
        });
        
        // Upload to Base44 private storage
        const uploadResponse = await base44.asServiceRole.integrations.Core.UploadPrivateFile({
            file: pdfFile
        });
        
        return Response.json({
            success: true,
            invoice_id: invoice.InvoiceID,
            invoice_number: invoice.InvoiceNumber,
            total: invoice.Total,
            status: invoice.Status,
            pdf_uri: uploadResponse.file_uri
        });
        
    } catch (error) {
        console.error('Xero invoice creation error:', error);
        return Response.json({ 
            error: 'Failed to create invoice',
            message: error.message 
        }, { status: 500 });
    }
});