import { createClientFromRequest } from 'npm:@base44/sdk@0.7.1';

const ZOHO_CRM_API_DOMAIN = Deno.env.get("ZOHO_CRM_API_DOMAIN");

Deno.serve(async (req) => {
    try {
        const base44 = createClientFromRequest(req);
        const user = await base44.auth.me();

        if (!user) {
            return Response.json({ error: 'Unauthorized' }, { status: 401 });
        }

        const { email, accessToken } = await req.json();
        
        if (!email || !accessToken) {
            return Response.json({ 
                error: 'Missing required parameters',
                required: ['email', 'accessToken']
            }, { status: 400 });
        }

        // Search for contact in Zoho CRM by email
        const searchResponse = await fetch(
            `${ZOHO_CRM_API_DOMAIN}/crm/v3/Contacts/search?email=${encodeURIComponent(email)}`,
            {
                headers: {
                    'Authorization': `Zoho-oauthtoken ${accessToken}`,
                },
            }
        );

        const searchData = await searchResponse.json();

        if (!searchResponse.ok || !searchData.data || searchData.data.length === 0) {
            return Response.json({ 
                error: 'Member not found in CRM',
                email: email 
            }, { status: 404 });
        }

        const contact = searchData.data[0];
        
        // Get associated Account (Organization) details
        let organizationName = null;
        let organizationId = null;
        let trainingFundBalance = 0;
        let purchaseOrderEnabled = false;
        let domain = null;
        let additionalVerifiedDomains = [];

        if (contact.Account_Name?.id) {
            const accountResponse = await fetch(
                `${ZOHO_CRM_API_DOMAIN}/crm/v3/Accounts/${contact.Account_Name.id}`,
                {
                    headers: {
                        'Authorization': `Zoho-oauthtoken ${accessToken}`,
                    },
                }
            );

            if (accountResponse.ok) {
                const accountData = await accountResponse.json();
                const account = accountData.data[0];
                
                organizationName = account.Account_Name;
                organizationId = account.id;
                trainingFundBalance = account.Training_Fund_Balance || 0;
                purchaseOrderEnabled = account.Purchase_Order_Enabled || false;
                domain = account.Domain || null;
                additionalVerifiedDomains = account.Additional_verified_domains || [];

                // Create or update Organization in base44
                const existingOrgs = await base44.asServiceRole.entities.Organization.filter({
                    zoho_account_id: organizationId
                });

                if (existingOrgs.length > 0) {
                    await base44.asServiceRole.entities.Organization.update(existingOrgs[0].id, {
                        name: organizationName,
                        domain: domain,
                        additional_verified_domains: additionalVerifiedDomains,
                        training_fund_balance: trainingFundBalance,
                        purchase_order_enabled: purchaseOrderEnabled,
                        last_synced: new Date().toISOString()
                    });
                } else {
                    await base44.asServiceRole.entities.Organization.create({
                        name: organizationName,
                        zoho_account_id: organizationId,
                        domain: domain,
                        additional_verified_domains: additionalVerifiedDomains,
                        training_fund_balance: trainingFundBalance,
                        purchase_order_enabled: purchaseOrderEnabled,
                        last_synced: new Date().toISOString()
                    });
                }
            }
        }

        // Create or update Member in base44
        const existingMembers = await base44.asServiceRole.entities.Member.filter({
            email: email
        });

        const memberData = {
            email: email,
            first_name: contact.First_Name,
            last_name: contact.Last_Name,
            zoho_contact_id: contact.id,
            organization_id: organizationId,
            last_synced: new Date().toISOString()
        };

        let member;
        if (existingMembers.length > 0) {
            await base44.asServiceRole.entities.Member.update(existingMembers[0].id, memberData);
            member = { ...existingMembers[0], ...memberData };
        } else {
            member = await base44.asServiceRole.entities.Member.create(memberData);
        }

        return Response.json({
            success: true,
            member: {
                ...member,
                organization_name: organizationName,
                training_fund_balance: trainingFundBalance,
                purchase_order_enabled: purchaseOrderEnabled
            }
        });

    } catch (error) {
        return Response.json({ 
            error: 'Failed to sync member data',
            message: error.message 
        }, { status: 500 });
    }
});