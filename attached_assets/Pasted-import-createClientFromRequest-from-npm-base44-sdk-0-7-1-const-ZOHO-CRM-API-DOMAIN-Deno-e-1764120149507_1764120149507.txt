import { createClientFromRequest } from 'npm:@base44/sdk@0.7.1';

const ZOHO_CRM_API_DOMAIN = Deno.env.get("ZOHO_CRM_API_DOMAIN");
const ZOHO_CLIENT_ID = Deno.env.get("ZOHO_CLIENT_ID");
const ZOHO_CLIENT_SECRET = Deno.env.get("ZOHO_CLIENT_SECRET");

async function getValidAccessToken(base44) {
    const tokens = await base44.asServiceRole.entities.ZohoToken.list();
    if (tokens.length === 0) throw new Error('No tokens');
    
    const token = tokens[0];
    if (new Date(token.expires_at) > new Date()) {
        return token.access_token;
    }
    
    const accountsDomain = ZOHO_CRM_API_DOMAIN.includes('.eu') ? 'https://accounts.zoho.eu' : 'https://accounts.zoho.com';
    const refreshResponse = await fetch(`${accountsDomain}/oauth/v2/token`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: new URLSearchParams({
            grant_type: 'refresh_token',
            client_id: ZOHO_CLIENT_ID,
            client_secret: ZOHO_CLIENT_SECRET,
            refresh_token: token.refresh_token,
        }),
    });
    
    const refreshData = await refreshResponse.json();
    if (refreshData.error) throw new Error(refreshData.error);
    
    await base44.asServiceRole.entities.ZohoToken.update(token.id, {
        access_token: refreshData.access_token,
        expires_at: new Date(Date.now() + refreshData.expires_in * 1000).toISOString(),
    });
    
    return refreshData.access_token;
}

Deno.serve(async (req) => {
    try {
        const base44 = createClientFromRequest(req);
        const { email, memberEmail, organizationId } = await req.json();
        
        if (!email || !organizationId) {
            return Response.json({ 
                valid: false,
                error: 'Missing required parameters' 
            }, { status: 400 });
        }

        const accessToken = await getValidAccessToken(base44);

        // Search for the colleague's contact in CRM
        const criteria = `(Email:equals:${email})`;
        const searchUrl = `${ZOHO_CRM_API_DOMAIN}/crm/v3/Contacts/search?criteria=${encodeURIComponent(criteria)}`;
        
        const searchResponse = await fetch(searchUrl, {
            headers: {
                'Authorization': `Zoho-oauthtoken ${accessToken}`,
            },
        });

        // Check if response has content before parsing
        let searchData = { data: [] };
        const responseText = await searchResponse.text();
        
        if (responseText && responseText.trim() !== '') {
            try {
                searchData = JSON.parse(responseText);
            } catch (e) {
                console.error('Failed to parse search response:', responseText);
                searchData = { data: [] };
            }
        }

        // If contact found, validate organization
        if (searchResponse.ok && searchData.data && searchData.data.length > 0) {
            const contact = searchData.data[0];

            // Check if the contact belongs to the same organization
            if (!contact.Account_Name?.id || contact.Account_Name.id !== organizationId) {
                return Response.json({ 
                    valid: false,
                    status: 'wrong_organization',
                    error: 'A ticket will be sent shortly. This email address cannot be verified, AGCAS will be in touch.'
                });
            }

            // Valid colleague - return their details
            return Response.json({
                valid: true,
                status: 'registered',
                first_name: contact.First_Name,
                last_name: contact.Last_Name,
                zoho_contact_id: contact.id
            });
        }

        // Contact not found - check domain matching
        const emailDomain = email.split('@')[1]?.toLowerCase();
        if (!emailDomain) {
            return Response.json({ 
                valid: false,
                status: 'invalid_email',
                error: 'Invalid email format'
            });
        }

        // Fetch organization details from CRM
        const orgResponse = await fetch(
            `${ZOHO_CRM_API_DOMAIN}/crm/v3/Accounts/${organizationId}`,
            {
                headers: {
                    'Authorization': `Zoho-oauthtoken ${accessToken}`,
                },
            }
        );

        if (!orgResponse.ok) {
            return Response.json({ 
                valid: true,
                status: 'external',
                message: 'External email address. AGCAS may reach out to validate eligibility.'
            });
        }

        const orgData = await orgResponse.json();
        const org = orgData.data[0];

        // Check primary domain
        const primaryDomain = org.Domain?.toLowerCase();
        if (primaryDomain && emailDomain === primaryDomain) {
            return Response.json({
                valid: true,
                status: 'unregistered_domain_match',
                message: 'A ticket and member welcome will be sent shortly.'
            });
        }

        // Check additional verified domains - safely handle non-array values
        let additionalDomains = org.Additional_verified_domains;
        
        // Ensure additionalDomains is always an array
        if (!Array.isArray(additionalDomains)) {
            if (additionalDomains === null || additionalDomains === undefined) {
                additionalDomains = [];
            } else if (typeof additionalDomains === 'string') {
                // If it's a string, try to split by comma or newline
                additionalDomains = additionalDomains
                    .split(/[,\n]/)
                    .map(d => d.trim())
                    .filter(d => d.length > 0);
            } else {
                console.warn('Unexpected type for Additional_verified_domains:', typeof additionalDomains);
                additionalDomains = [];
            }
        }

        const domainMatches = additionalDomains.some(
            domain => domain.toLowerCase() === emailDomain
        );

        if (domainMatches) {
            return Response.json({
                valid: true,
                status: 'unregistered_domain_match',
                message: 'A ticket and member welcome will be sent shortly.'
            });
        }

        // Domain doesn't match - external email
        return Response.json({
            valid: true,
            status: 'external',
            message: 'A ticket will be sent shortly. This email address cannot be verified, AGCAS will be in touch.'
        });

    } catch (error) {
        console.error('Validation error:', error);
        return Response.json({ 
            valid: false,
            status: 'error',
            error: error.message 
        }, { status: 500 });
    }
});