import { createClientFromRequest } from 'npm:@base44/sdk@0.7.1';

Deno.serve(async (req) => {
    try {
        const base44 = createClientFromRequest(req);
        
        // No user authentication check needed - this is an administrative task
        // that runs with service role privileges
        
        console.log('[updateExpiredVouchers] Starting voucher expiry check...');

        // Fetch all active vouchers using service role
        const allVouchers = await base44.asServiceRole.entities.Voucher.filter({
            status: 'active'
        });

        console.log('[updateExpiredVouchers] Found active vouchers:', allVouchers.length);

        // Check which ones have expired
        const now = new Date();
        console.log('[updateExpiredVouchers] Current time:', now.toISOString());
        
        const expiredVouchers = allVouchers.filter(v => {
            const expiryDate = new Date(v.expires_at);
            const isExpired = expiryDate.getTime() < now.getTime();
            if (isExpired) {
                console.log(`[updateExpiredVouchers] Voucher ${v.code} (${v.id}) expired at ${v.expires_at}`);
            }
            return isExpired;
        });

        console.log('[updateExpiredVouchers] Expired vouchers to update:', expiredVouchers.length);

        if (expiredVouchers.length === 0) {
            console.log('[updateExpiredVouchers] No expired vouchers to update');
            return Response.json({
                success: true,
                updated_count: 0,
                message: 'No expired vouchers found'
            });
        }

        // Update each expired voucher
        const updatePromises = expiredVouchers.map(voucher => {
            console.log(`[updateExpiredVouchers] Updating voucher ${voucher.code} (${voucher.id}) to expired status`);
            return base44.asServiceRole.entities.Voucher.update(voucher.id, {
                status: 'expired'
            });
        });

        await Promise.all(updatePromises);

        console.log('[updateExpiredVouchers] Successfully updated all expired vouchers');

        return Response.json({
            success: true,
            updated_count: expiredVouchers.length,
            expired_voucher_ids: expiredVouchers.map(v => v.id)
        });

    } catch (error) {
        console.error('[updateExpiredVouchers] Error:', error);
        console.error('[updateExpiredVouchers] Error stack:', error.stack);
        return Response.json({ 
            success: false,
            error: error.message,
            details: error.stack
        }, { status: 500 });
    }
});