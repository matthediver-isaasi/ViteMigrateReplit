import { createClientFromRequest } from 'npm:@base44/sdk@0.7.1';

Deno.serve(async (req) => {
    try {
        const base44 = createClientFromRequest(req);
        const webhookData = await req.json();
        
        // Zoho webhook sends contact data in a specific format
        // The structure might be: { module: 'Contacts', operation: 'insert/update', ids: [...] }
        // Or it might send the full contact data directly
        
        console.log('Webhook received:', JSON.stringify(webhookData, null, 2));
        
        // Extract contact information from webhook
        const contactData = webhookData.data || webhookData;
        
        if (!contactData.id || !contactData.Email) {
            return Response.json({ 
                success: false,
                error: 'Missing required contact data' 
            }, { status: 400 });
        }

        // Find which organization this contact belongs to
        let organizationId = null;
        if (contactData.Account_Name && contactData.Account_Name.id) {
            const allOrgs = await base44.asServiceRole.entities.Organization.list();
            const org = allOrgs.find(o => o.zoho_account_id === contactData.Account_Name.id);
            if (org) {
                organizationId = org.id;
            }
        }

        if (!organizationId) {
            // If we can't find the organization, we can't sync this contact
            return Response.json({ 
                success: true,
                message: 'Contact not associated with a synced organization'
            });
        }

        // Check if contact already exists
        const existingContacts = await base44.asServiceRole.entities.OrganizationContact.filter({
            zoho_contact_id: contactData.id
        });

        const contactRecord = {
            organization_id: organizationId,
            zoho_contact_id: contactData.id,
            email: contactData.Email,
            first_name: contactData.First_Name || '',
            last_name: contactData.Last_Name || '',
            is_active: true,
            last_synced: new Date().toISOString()
        };

        if (existingContacts.length > 0) {
            // Update existing contact
            await base44.asServiceRole.entities.OrganizationContact.update(
                existingContacts[0].id,
                contactRecord
            );
            
            return Response.json({
                success: true,
                action: 'updated',
                contact_id: existingContacts[0].id
            });
        } else {
            // Create new contact
            const newContact = await base44.asServiceRole.entities.OrganizationContact.create(contactRecord);
            
            return Response.json({
                success: true,
                action: 'created',
                contact_id: newContact.id
            });
        }

    } catch (error) {
        console.error('Webhook error:', error);
        return Response.json({ 
            success: false,
            error: error.message 
        }, { status: 500 });
    }
});